<% content_for :title, "Relatório de Notas" %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><i class="fas fa-chart-bar"></i> Relatório de Notas</h1>
  <%= link_to direction_reports_path, class: "btn btn-outline-secondary" do %>
    <i class="fas fa-arrow-left"></i> Voltar
  <% end %>
</div>

<!-- Filtros -->
<div class="card mb-4">
  <div class="card-body">
    <%= form_with url: grades_report_direction_reports_path, method: :get, local: true, class: "row g-3" do |form| %>
      <div class="col-md-4">
        <%= form.label :classroom_id, "Turma", class: "form-label" %>
        <%= form.select :classroom_id, 
                       options_from_collection_for_select(@classrooms, :id, :name, params[:classroom_id]), 
                       { prompt: "Todas as turmas" }, 
                       { class: "form-select" } %>
      </div>
      <div class="col-md-4">
        <%= form.label :subject_id, "Disciplina", class: "form-label" %>
        <%= form.select :subject_id, 
                       (@selected_classroom ? options_from_collection_for_select(@selected_classroom.subjects, :id, :name, params[:subject_id]) : []), 
                       { prompt: "Todas as disciplinas" }, 
                       { class: "form-select" } %>
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <%= form.submit "Filtrar", class: "btn btn-primary" %>
      </div>
    <% end %>
  </div>
</div>

<!-- Resultados -->
<% if @grades_data.present? %>
  <% if @selected_classroom %>
    <!-- Dados para turma específica -->
    <div class="card">
      <div class="card-header">
        <h5>Notas da Turma: <%= @selected_classroom.name %></h5>
        <% if @selected_subject %>
          <small class="text-muted">Disciplina: <%= @selected_subject.name %></small>
        <% end %>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Aluno</th>
                <% if @selected_subject %>
                  <th>Notas</th>
                <% else %>
                  <th>Disciplinas</th>
                <% end %>
                <th>Média</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <% @grades_data.each do |student_data| %>
                <tr>
                  <td><%= student_data[:student_name] %></td>
                  <td>
                    <% if @selected_subject %>
                      <%= student_data[:grades].map { |g| g[:grade] }.join(", ") %>
                    <% else %>
                      <small>
                        <% student_data[:grades].each do |grade_info| %>
                          <div><%= grade_info[:subject] %>: <%= grade_info[:grade] %></div>
                        <% end %>
                      </small>
                    <% end %>
                  </td>
                  <td>
                    <span class="badge bg-<%= student_data[:average] >= 7 ? 'success' : student_data[:average] >= 5 ? 'warning' : 'danger' %>">
                      <%= student_data[:average].round(1) %>
                    </span>
                  </td>
                  <td>
                    <% if student_data[:average] >= 7 %>
                      <span class="text-success">Aprovado</span>
                    <% elsif student_data[:average] >= 5 %>
                      <span class="text-warning">Recuperação</span>
                    <% else %>
                      <span class="text-danger">Reprovado</span>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  <% else %>
    <!-- Dados para toda a escola -->
    <div class="row">
      <% @grades_data.each do |classroom_data| %>
        <div class="col-md-6 mb-4">
          <div class="card">
            <div class="card-header">
              <h6><%= classroom_data[:classroom_name] %></h6>
              <small class="text-muted">
                <%= classroom_data[:students_count] %> alunos | 
                Média geral: <span class="badge bg-<%= classroom_data[:average_grade] >= 7 ? 'success' : classroom_data[:average_grade] >= 5 ? 'warning' : 'danger' %>">
                  <%= classroom_data[:average_grade] %>
                </span>
              </small>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Aluno</th>
                      <th>Média</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% classroom_data[:students_data].each do |student_data| %>
                      <tr>
                        <td><%= student_data[:student_name] %></td>
                        <td>
                          <span class="badge bg-<%= student_data[:average] >= 7 ? 'success' : student_data[:average] >= 5 ? 'warning' : 'danger' %>">
                            <%= student_data[:average].round(1) %>
                          </span>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>
<% else %>
  <div class="alert alert-info">
    <i class="fas fa-info-circle"></i> Selecione os filtros para visualizar o relatório de notas.
  </div>
<% end %>
