<% content_for :title, "Nova Disciplina" %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><i class="fas fa-book"></i> Nova Disciplina</h1>
  <%= link_to direction_subjects_path, class: "btn btn-outline-secondary" do %>
    <i class="fas fa-arrow-left"></i> Voltar
  <% end %>
</div>

<div class="row">
  <div class="col-lg-6 mx-auto">
    <%= form_with model: [:direction, @subject], local: true, class: "needs-validation", novalidate: true do |form| %>
      
      <% if @subject.errors.any? %>
        <div class="alert alert-danger">
          <h6><i class="fas fa-exclamation-triangle"></i> Erro ao criar disciplina:</h6>
          <ul class="mb-0">
            <% @subject.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>
      
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="fas fa-book"></i> Informações da Disciplina</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <%= form.label :name, "Nome da Disciplina *", class: "form-label" %>
            <%= form.text_field :name, class: "form-control", 
                               placeholder: "Ex: Matemática, Língua Portuguesa, História", required: true %>
            <div class="invalid-feedback">
              Por favor, informe o nome da disciplina.
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <%= form.label :code, "Código", class: "form-label" %>
              <%= form.text_field :code, class: "form-control", placeholder: "Ex: MAT, PORT" %>
            </div>

            <div class="col-md-6 mb-3">
              <%= form.label :workload, "Aulas por Semana *", class: "form-label" %>
              <%= form.number_field :workload, class: "form-control", min: 1, max: 10, placeholder: "4", required: true %>
              <div class="invalid-feedback">
                Por favor, informe a quantidade de aulas por semana.
              </div>
            </div>
          </div>

          <div class="mb-3">
            <%= form.label :area, "Área do Conhecimento *", class: "form-label" %>
            <%= form.select :area, 
                            options_for_select([
                              ['Selecione...', ''],
                              ['Linguagens', 'languages'],
                              ['Matemática', 'mathematics'],
                              ['Ciências da Natureza', 'natural_sciences'],
                              ['Ciências Humanas', 'human_sciences'],
                              ['Ensino Religioso', 'religious_education'],
                              ['Educação Física', 'physical_education'],
                              ['Artes', 'arts'],
                              ['Tecnologia', 'technology']
                            ], @subject.area),
                            {}, { class: "form-select", required: true } %>
            <div class="invalid-feedback">
              Por favor, selecione a área do conhecimento.
            </div>
          </div>

          <div class="mb-3">
            <%= form.label :user_id, "Professor Responsável", class: "form-label" %>
            <%= form.select :user_id, 
                            options_from_collection_for_select(
                              @teachers, 
                              :id, :full_name, 
                              @subject.user_id
                            ),
                            { prompt: "Selecione um professor..." }, 
                            { class: "form-select", 
                              data: { school_id: current_user.school.id } } %>
            <small class="form-text text-muted">
              Professores disponíveis: <%= @teachers.count %>
              <% if @teachers.empty? %>
                <br><span class="text-warning">⚠️ Nenhum professor cadastrado nesta escola.</span>
              <% end %>
            </small>
          </div>

          <div class="mb-3">
            <%= form.label :description, "Descrição (opcional)", class: "form-label" %>
            <%= form.text_area :description, class: "form-control", rows: 3, 
                              placeholder: "Breve descrição da disciplina..." %>
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-between mt-4">
        <%= link_to direction_subjects_path, class: "btn btn-outline-secondary" do %>
          <i class="fas fa-times"></i> Cancelar
        <% end %>
        
        <%= form.submit "Criar Disciplina", class: "btn btn-primary", 
                      id: "submit-btn", 
                      data: { disable_with: "Criando..." } %>
      </div>

    <% end %>
  </div>
</div>

<script>
// Validação do formulário
(function() {
  'use strict';
  window.addEventListener('load', function() {
    var forms = document.getElementsByClassName('needs-validation');
    var validation = Array.prototype.filter.call(forms, function(form) {
      form.addEventListener('submit', function(event) {
        if (form.checkValidity() === false) {
          event.preventDefault();
          event.stopPropagation();
          
          // Mostrar alerta se houver campos inválidos
          var firstInvalidField = form.querySelector(':invalid');
          if (firstInvalidField) {
            firstInvalidField.focus();
            
            // Mostrar toast de erro
            var alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-warning alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
              <i class="fas fa-exclamation-triangle"></i> 
              Por favor, preencha todos os campos obrigatórios marcados com *.
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            var existingAlert = form.querySelector('.alert-warning');
            if (existingAlert) {
              existingAlert.remove();
            }
            
            form.insertBefore(alertDiv, form.firstChild);
          }
        } else {
          // Se o formulário é válido, mostrar indicador de carregamento
          var submitBtn = document.getElementById('submit-btn');
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Criando...';
          }
        }
        form.classList.add('was-validated');
      }, false);
    });
  }, false);
})();
</script>
