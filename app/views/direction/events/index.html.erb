<% content_for :title, "Eventos" %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><i class="fas fa-calendar-alt"></i> Gerenciar Eventos</h1>
  <%= link_to new_direction_event_path, class: "btn btn-primary" do %>
    <i class="fas fa-plus"></i> Novo Evento
  <% end %>
</div>

<!-- Filtros e Busca -->
<div class="card mb-4">
  <div class="card-body">
    <%= form_with url: direction_events_path, method: :get, local: true, class: "row g-3" do |form| %>
      <div class="col-md-3">
        <%= form.text_field :search, placeholder: "Buscar eventos...", 
                           value: params[:search], class: "form-control" %>
      </div>
      <div class="col-md-2">
        <%= form.select :event_type, 
                        options_for_select([
                          ['Todos os tipos', ''],
                          ['Reunião', 'meeting'],
                          ['Evento Acadêmico', 'academic'],
                          ['Festa/Comemoração', 'celebration'],
                          ['Palestra', 'lecture'],
                          ['Formação', 'training'],
                          ['Avaliação', 'evaluation'],
                          ['Outros', 'other']
                        ], params[:event_type]),
                        {}, { class: "form-select" } %>
      </div>
      <div class="col-md-2">
        <%= form.select :status, 
                        options_for_select([
                          ['Todos', ''],
                          ['Planejado', 'planned'],
                          ['Em Andamento', 'ongoing'],
                          ['Concluído', 'completed'],
                          ['Cancelado', 'cancelled']
                        ], params[:status]),
                        {}, { class: "form-select" } %>
      </div>
      <div class="col-md-2">
        <%= form.date_field :start_date, value: params[:start_date], 
                           class: "form-control", placeholder: "Data início" %>
      </div>
      <div class="col-md-2">
        <%= form.date_field :end_date, value: params[:end_date], 
                           class: "form-control", placeholder: "Data fim" %>
      </div>
      <div class="col-md-1">
        <div class="d-grid">
          <%= form.submit "Filtrar", class: "btn btn-outline-secondary" %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- Estatísticas Rápidas -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h3 class="text-primary"><%= @events.count %></h3>
        <small class="text-muted">Total de Eventos</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h3 class="text-success"><%= @events.where('start_date >= ?', Date.current).count %></h3>
        <small class="text-muted">Próximos Eventos</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h3 class="text-warning"><%= @events.where(start_date: Date.current).count %></h3>
        <small class="text-muted">Eventos Hoje</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h3 class="text-info"><%= @events.where("start_date >= ?", Date.current).count %></h3>
        <small class="text-muted">Em Andamento</small>
      </div>
    </div>
  </div>
</div>

<!-- Eventos Próximos (Destaque) -->
<% upcoming_events = @events.where('start_date >= ? AND start_date <= ?', Date.current, 7.days.from_now).limit(3) %>
<% if upcoming_events.any? %>
  <div class="card mb-4 border-warning">
    <div class="card-header bg-warning text-dark">
      <h5 class="mb-0"><i class="fas fa-clock"></i> Eventos dos Próximos 7 Dias</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <% upcoming_events.each do |event| %>
          <div class="col-md-4 mb-3">
            <div class="card border-warning">
              <div class="card-body">
                <h6 class="card-title">
                  <i class="fas fa-<%= 
                    case event.event_type
                    when 'meeting' then 'users'
                    when 'academic' then 'graduation-cap'
                    when 'celebration' then 'birthday-cake'
                    when 'lecture' then 'microphone'
                    when 'training' then 'chalkboard-teacher'
                    when 'evaluation' then 'clipboard-check'
                    else 'calendar'
                    end
                  %>"></i>
                  <%= event.title %>
                </h6>
                <p class="card-text small">
                  <strong>Data:</strong> <%= event.start_date.strftime("%d/%m/%Y") %><br>
                  <strong>Horário:</strong> <%= event.start_time&.strftime("%H:%M") || 'Não definido' %>
                </p>
                <%= link_to direction_event_path(event), class: "btn btn-sm btn-outline-warning" do %>
                  Ver Detalhes
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<!-- Lista de Eventos -->
<div class="row">
  <% if @events.any? %>
    <% @events.each do |event| %>
      <div class="col-lg-6 col-md-12 mb-4">
        <div class="card h-100 
                    <%= 'border-success' if event.status == 'ongoing' %>
                    <%= 'border-danger' if event.status == 'cancelled' %>
                    <%= 'border-secondary' if event.status == 'completed' %>">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="fas fa-<%= 
                case event.event_type
                when 'meeting' then 'users'
                when 'academic' then 'graduation-cap'
                when 'celebration' then 'birthday-cake'
                when 'lecture' then 'microphone'
                when 'training' then 'chalkboard-teacher'
                when 'evaluation' then 'clipboard-check'
                else 'calendar'
                end
              %> text-primary"></i>
              <%= event.title %>
            </h5>
            <div class="dropdown">
              <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="fas fa-ellipsis-v"></i>
              </button>
              <ul class="dropdown-menu">
                <li>
                  <%= link_to direction_event_path(event), class: "dropdown-item" do %>
                    <i class="fas fa-eye"></i> Ver Detalhes
                  <% end %>
                </li>
                <li>
                  <%= link_to edit_direction_event_path(event), class: "dropdown-item" do %>
                    <i class="fas fa-edit"></i> Editar
                  <% end %>
                </li>
                <li>
                  <%= link_to "#", class: "dropdown-item", 
                             data: { bs_toggle: "modal", bs_target: "#duplicateModal#{event.id}" } do %>
                    <i class="fas fa-copy"></i> Duplicar
                  <% end %>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <%= link_to "#", class: "dropdown-item text-danger", 
                             data: { confirm: "Tem certeza que deseja cancelar este evento?" } do %>
                    <i class="fas fa-ban"></i> Cancelar
                  <% end %>
                </li>
              </ul>
            </div>
          </div>
          
          <div class="card-body">
            <!-- Status e Tipo -->
            <div class="row mb-3">
              <div class="col-6">
                <small class="text-muted">Status:</small>
                <br>
                <span class="badge bg-<%= 
                  case event.status
                  when 'planned' then 'primary'
                  when 'ongoing' then 'success'
                  when 'completed' then 'secondary'
                  when 'cancelled' then 'danger'
                  else 'secondary'
                  end
                %>">
                  <%= 
                    case event.status
                    when 'planned' then 'Planejado'
                    when 'ongoing' then 'Em Andamento'
                    when 'completed' then 'Concluído'
                    when 'cancelled' then 'Cancelado'
                    else 'Indefinido'
                    end
                  %>
                </span>
              </div>
              <div class="col-6">
                <small class="text-muted">Tipo:</small>
                <br>
                <span class="badge bg-info">
                  <%= 
                    case event.event_type
                    when 'meeting' then 'Reunião'
                    when 'academic' then 'Acadêmico'
                    when 'celebration' then 'Comemoração'
                    when 'lecture' then 'Palestra'
                    when 'training' then 'Formação'
                    when 'evaluation' then 'Avaliação'
                    when 'other' then 'Outros'
                    else 'Não definido'
                    end
                  %>
                </span>
              </div>
            </div>

            <!-- Data e Horário -->
            <div class="row mb-3">
              <div class="col-6">
                <small class="text-muted">Data:</small>
                <br>
                <strong><%= event.start_date.strftime("%d/%m/%Y") %></strong>
                <% if event.end_date && event.end_date != event.start_date %>
                  <small class="text-muted">até <%= event.end_date.strftime("%d/%m/%Y") %></small>
                <% end %>
              </div>
              <div class="col-6">
                <small class="text-muted">Horário:</small>
                <br>
                <% if event.start_time %>
                  <strong><%= event.start_time.strftime("%H:%M") %></strong>
                  <% if event.end_time %>
                    <small class="text-muted">às <%= event.end_time.strftime("%H:%M") %></small>
                  <% end %>
                <% else %>
                  <span class="text-muted">Não definido</span>
                <% end %>
              </div>
            </div>

            <!-- Local -->
            <% if event.location.present? %>
              <div class="mb-3">
                <small class="text-muted">Local:</small>
                <br>
                <i class="fas fa-map-marker-alt text-info"></i>
                <span><%= event.location %></span>
              </div>
            <% end %>

            <!-- Descrição -->
            <% if event.description.present? %>
              <div class="mb-3">
                <small class="text-muted">Descrição:</small>
                <p class="small"><%= truncate(event.description, length: 120) %></p>
              </div>
            <% end %>

            <!-- Participantes -->
            <% if event.target_audience.present? %>
              <div class="mb-3">
                <small class="text-muted">Público-alvo:</small>
                <br>
                <% event.target_audience.each do |audience| %>
                  <span class="badge bg-light text-dark me-1">
                    <%= 
                      case audience
                      when 'students' then 'Alunos'
                      when 'teachers' then 'Professores'
                      when 'parents' then 'Pais'
                      when 'staff' then 'Funcionários'
                      when 'community' then 'Comunidade'
                      else audience.humanize
                      end
                    %>
                  </span>
                <% end %>
              </div>
            <% end %>

            <!-- Organização -->
            <% if event.organizer.present? %>
              <div class="mb-2">
                <small class="text-muted">Organizado por:</small>
                <br>
                <span class="small"><%= event.organizer %></span>
              </div>
            <% end %>

            <!-- Capacidade -->
            <% if event.capacity.present? %>
              <div class="mb-2">
                <small class="text-muted">Capacidade:</small>
                <br>
                <div class="progress" style="height: 6px;">
                  <% occupancy = event.attendees_count ? (event.attendees_count.to_f / event.capacity * 100).round(1) : 0 %>
                  <div class="progress-bar bg-<%= occupancy > 90 ? 'danger' : occupancy > 70 ? 'warning' : 'success' %>" 
                       style="width: <%= occupancy %>%"></div>
                </div>
                <small class="text-muted">
                  <%= event.attendees_count || 0 %>/<%= event.capacity %> pessoas 
                  (<%= occupancy %>%)
                </small>
              </div>
            <% end %>
          </div>

          <div class="card-footer">
            <div class="d-flex justify-content-between align-items-center">
              <small class="text-muted">
                <i class="fas fa-calendar-plus"></i>
                Criado em <%= event.created_at.strftime("%d/%m/%Y") %>
              </small>
              <%= link_to direction_event_path(event), class: "btn btn-sm btn-outline-primary" do %>
                <i class="fas fa-arrow-right"></i> Ver Mais
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% else %>
    <div class="col-12">
      <div class="card">
        <div class="card-body text-center py-5">
          <i class="fas fa-calendar-alt fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">Nenhum evento encontrado</h5>
          <p class="text-muted">
            <% if params.any? %>
              Não há eventos que correspondam aos filtros selecionados.
            <% else %>
              Nenhum evento foi criado ainda.
            <% end %>
          </p>
          <%= link_to new_direction_event_path, class: "btn btn-primary" do %>
            <i class="fas fa-plus"></i> Criar Primeiro Evento
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
</div>

<!-- Calendário Resumido -->
<% if @events.any? %>
  <div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5><i class="fas fa-calendar"></i> Calendário do Mês</h5>
      <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#calendarModal">
        <i class="fas fa-expand"></i> Ver Calendário Completo
      </button>
    </div>
    <div class="card-body">
      <div class="row">
        <% events_this_month = @events.where(start_date: Date.current.beginning_of_month..Date.current.end_of_month) %>
        <% events_by_day = events_this_month.group_by(&:start_date) %>
        
        <% (1..Date.current.end_of_month.day).each do |day| %>
          <% current_date = Date.new(Date.current.year, Date.current.month, day) %>
          <% day_events = events_by_day[current_date] || [] %>
          
          <div class="col-1 p-1">
            <div class="border rounded p-2 text-center 
                        <%= 'bg-primary text-white' if current_date == Date.current %>
                        <%= 'bg-light' if day_events.any? && current_date != Date.current %>">
              <small><%= day %></small>
              <% if day_events.any? %>
                <br><span class="badge bg-success" style="font-size: 8px;"><%= day_events.count %></span>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<!-- Modal Calendário Completo -->
<div class="modal fade" id="calendarModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-calendar"></i> Calendário de Eventos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="calendar-container">
          <!-- Aqui seria integrado um calendário completo como FullCalendar.js -->
          <p class="text-center text-muted">Calendário completo será implementado aqui</p>
        </div>
      </div>
    </div>
  </div>
</div>
