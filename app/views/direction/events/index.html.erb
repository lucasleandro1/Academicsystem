<% content_for :title, "Eventos" %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><i class="fas fa-calendar-alt"></i> Gerenciar Eventos</h1>
  <%= link_to new_direction_event_path, class: "btn btn-primary" do %>
    <i class="fas fa-plus"></i> Novo Evento
  <% end %>
</div>

<!-- Filtros e Busca -->
<div class="card mb-4">
  <div class="card-body">
    <%= form_with url: direction_events_path, method: :get, local: true, class: "row g-3" do |form| %>
      <div class="col-md-3">
        <%= form.text_field :search, placeholder: "Buscar eventos...", 
                           value: params[:search], class: "form-control" %>
      </div>
      <div class="col-md-2">
        <%= form.select :event_type, 
                        options_for_select([
                          ['Todos os tipos', ''],
                          ['Acadêmico', 'academico'],
                          ['Cultural', 'cultural'],
                          ['Esportivo', 'esportivo'],
                          ['Administrativo', 'administrativo'],
                          ['Reunião', 'reuniao'],
                          ['Feriado', 'feriado']
                        ], params[:event_type]),
                        {}, { class: "form-select" } %>
      </div>
      <div class="col-md-2">
        <%= form.select :status, 
                        options_for_select([
                          ['Todos', ''],
                          ['Planejado', 'planned'],
                          ['Em Andamento', 'ongoing'],
                          ['Concluído', 'completed'],
                          ['Cancelado', 'cancelled']
                        ], params[:status]),
                        {}, { class: "form-select" } %>
      </div>
      <div class="col-md-2">
        <%= form.date_field :start_date, value: params[:start_date], 
                           class: "form-control", placeholder: "Data início" %>
      </div>
      <div class="col-md-2">
        <%= form.date_field :end_date, value: params[:end_date], 
                           class: "form-control", placeholder: "Data fim" %>
      </div>
      <div class="col-md-1">
        <div class="d-grid">
          <%= form.submit "Filtrar", class: "btn btn-outline-secondary" %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- Estatísticas Rápidas -->
<% all_events = current_user.school.events %>
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h3 class="text-primary"><%= @events.count %></h3>
        <small class="text-muted">
          <%= params[:status] == 'completed' ? 'Eventos Concluídos' : 
              params[:status].present? ? 'Eventos Filtrados' : 'Eventos Ativos' %>
        </small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h3 class="text-success"><%= all_events.where("COALESCE(start_date, event_date) > ?", Date.current).count %></h3>
        <small class="text-muted">Eventos Futuros</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h3 class="text-warning"><%= all_events.where("COALESCE(start_date, event_date) = ?", Date.current).count %></h3>
        <small class="text-muted">Eventos Hoje</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h3 class="text-secondary"><%= all_events.where("COALESCE(start_date, event_date) < ?", Date.current).count %></h3>
        <small class="text-muted">Eventos Concluídos</small>
      </div>
    </div>
  </div>
</div>

<!-- Alerta sobre filtro padrão -->
<% unless params[:status].present? %>
  <div class="alert alert-info alert-dismissible fade show" role="alert">
    <i class="fas fa-info-circle"></i>
    <strong>Visualização padrão:</strong> Mostrando apenas eventos ativos (futuros e de hoje). 
    Use o filtro de status para ver eventos concluídos.
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
<% end %>

<!-- Eventos Próximos (Destaque) -->
<% upcoming_events = current_user.school.events.where("COALESCE(start_date, event_date) >= ? AND COALESCE(start_date, event_date) <= ?", Date.current, 7.days.from_now).order(Arel.sql("COALESCE(start_date, event_date) ASC")).limit(3) %>
<% if upcoming_events.any? %>
  <div class="card mb-4 border-warning">
    <div class="card-header bg-warning text-dark">
      <h5 class="mb-0"><i class="fas fa-clock"></i> Eventos dos Próximos 7 Dias</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <% upcoming_events.each do |event| %>
          <div class="col-md-4 mb-3">
            <div class="card border-warning">
              <div class="card-body">
                <h6 class="card-title">
                  <i class="fas fa-<%= 
                    case event.event_type
                    when 'academico' then 'graduation-cap'
                    when 'cultural' then 'theater-masks'
                    when 'esportivo' then 'futbol'
                    when 'administrativo' then 'briefcase'
                    when 'reuniao' then 'users'
                    when 'feriado' then 'calendar-day'
                    else 'calendar'
                    end
                  %>"></i>
                  <%= event.title %>
                </h6>
                <p class="card-text small">
                  <strong>Data:</strong> <%= event.formatted_start_date %><br>
                  <strong>Horário:</strong> <%= event.formatted_start_time %>
                </p>
                <%= link_to direction_event_path(event), class: "btn btn-sm btn-outline-warning" do %>
                  Ver Detalhes
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<!-- Lista de Eventos -->
<div class="row">
  <% if @events.any? %>
    <% @events.each do |event| %>
      <div class="col-lg-6 col-md-12 mb-4">
        <div class="card h-100 
                    <%= 'border-success' if event.status == 'ongoing' %>
                    <%= 'border-danger' if event.status == 'cancelled' %>
                    <%= 'border-secondary' if event.status == 'completed' %>">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="fas fa-<%= 
                case event.event_type
                when 'academico' then 'graduation-cap'
                when 'cultural' then 'theater-masks'
                when 'esportivo' then 'futbol'
                when 'administrativo' then 'briefcase'
                when 'reuniao' then 'users'
                when 'feriado' then 'calendar-day'
                else 'calendar'
                end
              %> text-primary"></i>
              <%= event.title %>
            </h5>
            <div class="dropdown">
              <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="fas fa-ellipsis-v"></i>
              </button>
              <ul class="dropdown-menu">
                <li>
                  <%= link_to direction_event_path(event), class: "dropdown-item" do %>
                    <i class="fas fa-eye"></i> Ver Detalhes
                  <% end %>
                </li>
                <li>
                  <%= link_to edit_direction_event_path(event), class: "dropdown-item" do %>
                    <i class="fas fa-edit"></i> Editar
                  <% end %>
                </li>
                <li>
                  <%= link_to "#", class: "dropdown-item", 
                             data: { bs_toggle: "modal", bs_target: "#duplicateModal#{event.id}" } do %>
                    <i class="fas fa-copy"></i> Duplicar
                  <% end %>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <%= link_to "#", class: "dropdown-item text-danger", 
                             data: { confirm: "Tem certeza que deseja cancelar este evento?" } do %>
                    <i class="fas fa-ban"></i> Cancelar
                  <% end %>
                </li>
              </ul>
            </div>
          </div>
          
          <div class="card-body">
            <!-- Status e Tipo -->
            <div class="row mb-3">
              <div class="col-6">
                <small class="text-muted">Status:</small>
                <br>
                <span class="badge bg-<%= 
                  case event.status
                  when 'planned' then 'primary'
                  when 'ongoing' then 'success'
                  when 'completed' then 'secondary'
                  when 'cancelled' then 'danger'
                  else 'secondary'
                  end
                %>">
                  <%= 
                    case event.status
                    when 'planned' then 'Planejado'
                    when 'ongoing' then 'Em Andamento'
                    when 'completed' then 'Concluído'
                    when 'cancelled' then 'Cancelado'
                    else 'Indefinido'
                    end
                  %>
                </span>
              </div>
              <div class="col-6">
                <small class="text-muted">Tipo:</small>
                <br>
                <span class="badge bg-info">
                  <%= 
                    case event.event_type
                    when 'academico' then 'Acadêmico'
                    when 'cultural' then 'Cultural'
                    when 'esportivo' then 'Esportivo'
                    when 'administrativo' then 'Administrativo'
                    when 'reuniao' then 'Reunião'
                    when 'feriado' then 'Feriado'
                    else 'Não definido'
                    end
                  %>
                </span>
              </div>
            </div>

            <!-- Data e Horário -->
            <div class="row mb-3">
              <div class="col-6">
                <small class="text-muted">Data:</small>
                <br>
                <strong><%= event.formatted_start_date %></strong>
                <% if event.end_date && event.end_date != event.start_date %>
                  <small class="text-muted">até <%= event.formatted_end_date %></small>
                <% end %>
              </div>
              <div class="col-6">
                <small class="text-muted">Horário:</small>
                <br>
                <% if event.start_time %>
                  <strong><%= event.formatted_start_time %></strong>
                  <% if event.end_time %>
                    <small class="text-muted">às <%= event.formatted_end_time %></small>
                  <% end %>
                <% else %>
                  <span class="text-muted">Não definido</span>
                <% end %>
              </div>
            </div>

            <!-- Descrição -->
            <% if event.description.present? %>
              <div class="mb-3">
                <small class="text-muted">Descrição:</small>
                <p class="small"><%= truncate(event.description, length: 120) %></p>
              </div>
            <% end %>
          </div>

          <div class="card-footer">
            <div class="d-flex justify-content-between align-items-center">
              <small class="text-muted">
                <i class="fas fa-calendar-plus"></i>
                Criado em <%= event.formatted_created_at %>
              </small>
              <%= link_to direction_event_path(event), class: "btn btn-sm btn-outline-primary" do %>
                <i class="fas fa-arrow-right"></i> Ver Mais
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% else %>
    <div class="col-12">
      <div class="card">
        <div class="card-body text-center py-5">
          <i class="fas fa-calendar-alt fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">Nenhum evento encontrado</h5>
          <p class="text-muted">
            <% if params[:search].present? || params[:event_type].present? || params[:status].present? || params[:start_date].present? || params[:end_date].present? %>
              Não há eventos que correspondam aos filtros selecionados.
            <% else %>
              Nenhum evento ativo encontrado.
            <% end %>
          </p>
          <div class="d-flex gap-2 justify-content-center">
            <%= link_to new_direction_event_path, class: "btn btn-primary" do %>
              <i class="fas fa-plus"></i> Criar Novo Evento
            <% end %>
            <% unless params[:status] == 'completed' %>
              <%= link_to direction_events_path(status: 'completed'), class: "btn btn-outline-secondary" do %>
                <i class="fas fa-history"></i> Ver Eventos Concluídos
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>

