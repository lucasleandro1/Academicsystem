<% content_for :title, "Alunos" %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><i class="fas fa-user-graduate"></i> Gerenciar Alunos</h1>
  <%= link_to new_direction_student_path, class: "btn btn-primary" do %>
    <i class="fas fa-user-plus"></i> Novo Aluno
  <% end %>
</div>

<!-- Filtros e Busca -->
<div class="card mb-4">
  <div class="card-body">
    <%= form_with url: direction_students_path, method: :get, local: true, class: "row g-3" do |form| %>
      <div class="col-md-4">
        <%= form.text_field :search, placeholder: "Buscar por nome, e-mail ou matrícula...", 
                           value: params[:search], class: "form-control" %>
      </div>
      <div class="col-md-3">
        <%= form.select :classroom_id, 
                        options_from_collection_for_select(current_user.school.classrooms, :id, :name, params[:classroom_id]),
                        { prompt: "Todas as turmas" }, { class: "form-select" } %>
      </div>
      <div class="col-md-2">
        <%= form.select :status, 
                        options_for_select([['Todos', ''], ['Ativos', 'active'], ['Inativos', 'inactive']], params[:status]),
                        {}, { class: "form-select" } %>
      </div>
      <div class="col-md-3">
        <div class="d-grid">
          <%= form.submit "Filtrar", class: "btn btn-outline-secondary" %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- Estatísticas Rápidas -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h3 class="text-primary"><%= @students.count %></h3>
        <small class="text-muted">Total de Alunos</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h3 class="text-success"><%= @students.where(active: true).count %></h3>
        <small class="text-muted">Alunos Ativos</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h3 class="text-info"><%= Enrollment.joins(:classroom).where(classrooms: { school_id: current_user.school.id }).where(status: 'active').count %></h3>
        <small class="text-muted">Matriculados</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h3 class="text-warning"><%= Enrollment.joins(:student).joins(:classroom).where(classrooms: { school: current_user.school }).where(users: { user_type: 'student' }).where(status: 'pending').count %></h3>
        <small class="text-muted">Pendentes</small>
      </div>
    </div>
  </div>
</div>

<!-- Lista de Alunos -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">Lista de Alunos (<%= @students.count %>)</h5>
    <div class="btn-group">
      <%= link_to direction_students_path(format: :csv), class: "btn btn-sm btn-outline-success" do %>
        <i class="fas fa-download"></i> Exportar CSV
      <% end %>
      <%= link_to direction_students_path(format: :pdf), class: "btn btn-sm btn-outline-danger" do %>
        <i class="fas fa-file-pdf"></i> Exportar PDF
      <% end %>
    </div>
  </div>
  <div class="card-body p-0">
    <% if @students.any? %>
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Aluno</th>
              <th>Matrícula</th>
              <th>Turma</th>
              <th>Contato</th>
              <th>Responsável</th>
              <th>Status</th>
              <th width="150">Ações</th>
            </tr>
          </thead>
          <tbody>
            <% @students.each do |student| %>
              <tr>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="bg-primary rounded-circle me-2 d-flex align-items-center justify-content-center" 
                         style="width: 40px; height: 40px;">
                      <i class="fas fa-user text-white"></i>
                    </div>
                    <div>
                      <strong><%= student.full_name %></strong>
                      <br>
                      <small class="text-muted">
                        <% if student.birth_date.present? %>
                          <%= pluralize((Date.current - student.birth_date).to_i / 365, 'ano') %>
                        <% end %>
                      </small>
                    </div>
                  </div>
                </td>
                <td>
                  <strong><%= student.registration_number %></strong>
                  <br>
                  <small class="text-muted">
                    Ingressou em <%= student.created_at.strftime("%m/%Y") %>
                  </small>
                </td>
                <td>
                  <% enrollment = student.enrollments.where(status: 'active').first %>
                  <% if enrollment&.classroom %>
                    <span class="badge bg-info"><%= enrollment.classroom.name %></span>
                    <br>
                    <small class="text-muted"><%= enrollment.classroom.shift.humanize %></small>
                  <% else %>
                    <span class="text-muted">Sem turma</span>
                  <% end %>
                </td>
                <td>
                  <i class="fas fa-envelope text-muted"></i> <%= student.email %>
                  <% if student.phone.present? %>
                    <br>
                    <i class="fas fa-phone text-muted"></i> <%= student.phone %>
                  <% end %>
                </td>
                <td>
                  <% if student.guardian_name.present? %>
                    <strong><%= student.guardian_name %></strong>
                    <% if student.respond_to?(:guardian_phone) && student.guardian_phone.present? %>
                      <br>
                      <small class="text-muted">
                        <i class="fas fa-phone"></i> <%= student.guardian_phone %>
                      </small>
                    <% end %>
                  <% else %>
                    <span class="text-muted">Não informado</span>
                  <% end %>
                </td>
                <td>
                  <% if student.active? %>
                    <span class="badge bg-success">Ativo</span>
                  <% else %>
                    <span class="badge bg-danger">Inativo</span>
                  <% end %>
                  <% enrollment = student.enrollments.where(status: 'active').first %>
                  <% if enrollment %>
                    <br>
                    <span class="badge bg-primary">Matriculado</span>
                  <% end %>
                </td>
                <td>
                  <div class="btn-group" role="group">
                    <%= link_to direction_student_path(student), class: "btn btn-sm btn-outline-primary", 
                               title: "Visualizar" do %>
                      <i class="fas fa-eye"></i>
                    <% end %>
                    <%= link_to edit_direction_student_path(student), class: "btn btn-sm btn-outline-secondary", 
                               title: "Editar" do %>
                      <i class="fas fa-edit"></i>
                    <% end %>
                    <div class="btn-group">
                      <button type="button" class="btn btn-sm btn-outline-info dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-tools"></i>
                      </button>
                      <ul class="dropdown-menu">
                        <li>
                          <%= link_to direction_student_enrollments_path(student), class: "dropdown-item" do %>
                            <i class="fas fa-id-card"></i> Matrículas
                          <% end %>
                        </li>
                        <li>
                          <%= link_to direction_student_grades_path(student), class: "dropdown-item" do %>
                            <i class="fas fa-chart-line"></i> Notas
                          <% end %>
                        </li>
                        <li>
                          <%= link_to direction_student_absences_path(student), class: "dropdown-item" do %>
                            <i class="fas fa-calendar-times"></i> Faltas
                          <% end %>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                          <%= link_to direction_student_path(student), method: :delete, 
                                     class: "dropdown-item text-danger",
                                     data: { 
                                       confirm: "Tem certeza que deseja excluir este aluno?",
                                       turbo_method: :delete 
                                     } do %>
                            <i class="fas fa-trash"></i> Excluir
                          <% end %>
                        </li>
                      </ul>
                    </div>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="text-center py-5">
        <i class="fas fa-user-graduate fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">Nenhum aluno encontrado</h5>
        <p class="text-muted">Cadastre o primeiro aluno da escola.</p>
        <%= link_to new_direction_student_path, class: "btn btn-primary" do %>
          <i class="fas fa-user-plus"></i> Cadastrar Aluno
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<!-- Paginação -->
<% if @students.respond_to?(:current_page) %>
  <div class="d-flex justify-content-center mt-4">
    <%= paginate @students %>
  </div>
<% end %>
