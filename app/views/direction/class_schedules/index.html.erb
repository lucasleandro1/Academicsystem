<% content_for :title, "Grade de Horários" %>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2">Grade de Horários</h1>
  <%= link_to new_direction_class_schedule_path, class: "btn btn-primary" do %>
    <i class="fas fa-plus"></i> Novo Horário
  <% end %>
</div>

<!-- Seletor de Turma -->
<div class="row mb-4">
  <div class="col-12">
    <%= form_with url: direction_class_schedules_path, method: :get, local: true, class: "d-flex align-items-center gap-3" do |form| %>
      <label class="form-label mb-0"><strong>Turma:</strong></label>
      <%= form.select :classroom_id, 
                      options_from_collection_for_select(@classrooms, :id, :name, params[:classroom_id]),
                      { prompt: "Selecione uma turma" }, 
                      { class: "form-select", style: "width: auto;", onchange: "this.form.submit();" } %>
    <% end %>
  </div>
</div>

<!-- Grade de Horários -->
<div class="row">
  <div class="col-12">
    <% if @selected_classroom %>
      <h4 class="mb-3">Turma: <span class="badge bg-primary"><%= @selected_classroom.name %></span></h4>
      
      <% if @class_schedules.any? %>
        <div class="table-responsive">
          <table class="table table-bordered">
            <thead class="table-light">
              <tr>
                <th>Horário</th>
                <th>Segunda</th>
                <th>Terça</th>
                <th>Quarta</th>
                <th>Quinta</th>
                <th>Sexta</th>
                <th>Sábado</th>
              </tr>
            </thead>
            <tbody>
              <% 
                # Obter slots de horários únicos dos horários cadastrados
                time_slots = @class_schedules.map { |cs| "#{cs.start_time.strftime('%H:%M')} - #{cs.end_time.strftime('%H:%M')}" }.uniq.sort
                
                # Se não há horários, usar horários padrão
                if time_slots.empty?
                  time_slots = [
                    "07:00 - 07:45", "07:45 - 08:30", "08:30 - 09:15", "09:30 - 10:15",
                    "10:15 - 11:00", "11:00 - 11:45", "13:30 - 14:15", "14:15 - 15:00",
                    "15:00 - 15:45", "16:00 - 16:45", "16:45 - 17:30"
                  ]
                end
              %>
              
              <% time_slots.each do |time_slot| %>
                <tr>
                  <td class="table-light">
                    <strong><%= time_slot %></strong>
                  </td>
                  <% (1..6).each do |day_number| %>
                    <td>
                      <% schedule = @class_schedules.find { |cs| cs.weekday == day_number && "#{cs.start_time.strftime('%H:%M')} - #{cs.end_time.strftime('%H:%M')}" == time_slot } %>
                      <% if schedule %>
                        <div class="small">
                          <strong><%= schedule.subject.name %></strong><br>
                          <span class="text-muted">
                            <%= schedule.subject.teacher.full_name %>
                          </span>
                        </div>
                      <% end %>
                    </td>
                  <% end %>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          Esta turma ainda não possui horários de aula cadastrados.
        </div>
      <% end %>
    <% else %>
      <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle"></i>
        Selecione uma turma acima para visualizar sua grade de horários.
      </div>
    <% end %>
  </div>
</div>

<!-- Lista de Turmas e Estatísticas -->
<div class="row mt-4">
  <div class="col-12">
    <h4>Resumo das Turmas</h4>
    <% if @classrooms.any? %>
      <div class="row">
        <% @classrooms.each do |classroom| %>
          <div class="col-md-6 col-lg-4 mb-3">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">
                  <%= link_to direction_class_schedules_path(classroom_id: classroom.id), class: "text-decoration-none" do %>
                    <%= classroom.name %>
                  <% end %>
                </h6>
                <p class="card-text">
                  <small class="text-muted">
                    <i class="fas fa-calendar-check"></i> 
                    <%= @class_schedules.select { |cs| cs.classroom_id == classroom.id }.count %> horários<br>
                    <i class="fas fa-users"></i> 
                    <%= classroom.students.count %> alunos
                  </small>
                </p>
                <%= link_to direction_class_schedules_path(classroom_id: classroom.id), class: "btn btn-sm btn-outline-primary" do %>
                  <i class="fas fa-eye"></i> Ver Grade
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle"></i>
        Nenhuma turma cadastrada no sistema.
      </div>
    <% end %>
  </div>
</div>
