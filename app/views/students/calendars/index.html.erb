<% content_for :title, "Calendário Acadêmico" %>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <div>
    <h1 class="h2">
      <i class="fas fa-calendar-alt text-primary me-2"></i>
      Calendário Acadêmico
    </h1>
    <p class="text-muted mb-0">
      Consulte feriados, férias, eventos e datas importantes do calendário letivo
      <% if current_user.school.present? %>
        - <%= current_user.school.name %>
      <% end %>
    </p>
  </div>
</div>

<!-- Navegação do Calendário -->
<div class="card mb-4">
  <div class="card-header">
    <div class="row align-items-center">
      <div class="col-md-4">
        <%= link_to students_calendars_path(date: @prev_month), 
                   class: "btn btn-outline-primary" do %>
          <i class="fas fa-chevron-left"></i> <%= @prev_month.strftime("%B %Y") %>
        <% end %>
      </div>
      <div class="col-md-4 text-center">
        <h4 class="mb-0">
          <i class="fas fa-calendar me-2"></i>
          <%= @current_month.strftime("%B de %Y") %>
        </h4>
      </div>
      <div class="col-md-4 text-end">
        <%= link_to students_calendars_path(date: @next_month), 
                   class: "btn btn-outline-primary" do %>
          <%= @next_month.strftime("%B %Y") %> <i class="fas fa-chevron-right"></i>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Filtros de Busca -->
<div class="card mb-4">
  <div class="card-body">
    <%= form_with url: students_calendars_path, method: :get, local: true, class: "row g-3" do |form| %>
      <%= form.hidden_field :date, value: @current_date %>
      <div class="col-md-6">
        <%= form.text_field :search, value: params[:search], 
                           placeholder: "Buscar eventos...", 
                           class: "form-control" %>
      </div>
      <div class="col-md-4">
        <%= form.select :calendar_type, 
                       options_for_select([['Todos os tipos', '']] + 
                       @calendar_types.map { |type| [Calendar.new(calendar_type: type).type_description, type] }, 
                       params[:calendar_type]), 
                       {}, { class: "form-select" } %>
      </div>
      <div class="col-md-2">
        <%= form.submit "Filtrar", class: "btn btn-primary w-100" %>
      </div>
      <div class="col-md-12 text-end mt-2">
        <%= link_to "Limpar Filtros", students_calendars_path(date: @current_date), class: "btn btn-sm btn-outline-secondary" %>
      </div>
    <% end %>
  </div>
</div>

<!-- Legenda dos Tipos de Eventos -->
<div class="card mb-4">
  <div class="card-body">
    <h6 class="card-title mb-3">
      <i class="fas fa-info-circle me-2"></i>
      Legenda dos Tipos de Eventos
    </h6>
    <div class="row">
      <% @calendar_types.each do |type| %>
        <div class="col-md-3 mb-2">
          <span class="badge bg-<%= case type
                                   when 'holiday', 'municipal_holiday' then 'danger'
                                   when 'vacation' then 'success' 
                                   when 'school_start', 'school_end' then 'primary'
                                   when 'exam_period' then 'warning'
                                   when 'meeting' then 'purple'
                                   when 'pedagogical_day', 'teacher_training' then 'secondary'
                                   when 'event' then 'dark'
                                   when 'deadline' then 'danger'
                                   when 'suspension' then 'warning'
                                   else 'secondary'
                                   end %> me-2">
            <%= Calendar.new(calendar_type: type).type_description %>
          </span>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Calendário Visual -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">
      <i class="fas fa-calendar-week me-2"></i>
      Calendário do Mês
    </h5>
  </div>
  <div class="card-body p-0">
    <div class="calendar-grid">
      <!-- Cabeçalho dos dias da semana -->
      <div class="calendar-header">
        <div class="calendar-day-header">Dom</div>
        <div class="calendar-day-header">Seg</div>
        <div class="calendar-day-header">Ter</div>
        <div class="calendar-day-header">Qua</div>
        <div class="calendar-day-header">Qui</div>
        <div class="calendar-day-header">Sex</div>
        <div class="calendar-day-header">Sáb</div>
      </div>
      
      <!-- Dias do calendário -->
      <div class="calendar-body">
        <% 
        # Calcular o primeiro dia da semana do mês
        first_day = @current_month.beginning_of_month
        start_date = first_day.beginning_of_week(:sunday)
        
        # Calcular quantas semanas mostrar (normalmente 6 para cobrir todo o mês)
        weeks = 6
        
        (0...weeks).each do |week|
          %>
          <div class="calendar-week">
            <% (0...7).each do |day| %>
              <% 
              current_day = start_date + (week * 7 + day).days
              is_current_month = current_day.month == @current_month.month
              is_today = current_day == Date.current
              day_events = @events_by_date[current_day] || []
              day_municipal_events = @municipal_events_by_date[current_day] || []
              all_day_events = day_events + day_municipal_events
              %>
              
              <div class="calendar-day <%= 'other-month' unless is_current_month %> 
                                       <%= 'today' if is_today %>
                                       <%= 'has-events' if all_day_events.any? %>">
                <div class="day-number">
                  <%= current_day.day %>
                  <% if is_today %>
                    <span class="today-indicator"></span>
                  <% end %>
                </div>
                
                <% if all_day_events.any? %>
                  <div class="day-events">
                    <% all_day_events.first(3).each do |event| %>
                      <% if event.is_a?(Calendar) %>
                        <div class="event-item bg-<%= case event.calendar_type
                                                    when 'holiday', 'municipal_holiday' then 'danger'
                                                    when 'vacation' then 'success'
                                                    when 'school_start', 'school_end' then 'primary'
                                                    when 'exam_period' then 'warning' 
                                                    when 'meeting' then 'purple'
                                                    when 'pedagogical_day', 'teacher_training' then 'secondary'
                                                    when 'event' then 'dark'
                                                    when 'deadline' then 'danger'
                                                    when 'suspension' then 'warning'
                                                    else 'secondary'
                                                    end %>"
                             data-bs-toggle="tooltip" 
                             data-bs-placement="top"
                             title="<%= event.title %> - <%= event.type_description %>">
                          <%= truncate(event.title, length: 12) %>
                        </div>
                      <% else %>
                        <div class="event-item bg-info"
                             data-bs-toggle="tooltip" 
                             data-bs-placement="top"
                             title="<%= event.title %> - Evento <%= event.municipal? ? 'Municipal' : 'da Escola' %>">
                          <%= truncate(event.title, length: 12) %>
                        </div>
                      <% end %>
                    <% end %>
                    <% if all_day_events.count > 3 %>
                      <div class="more-events">
                        +<%= all_day_events.count - 3 %> mais
                      </div>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Lista de Eventos do Mês -->
<% total_events = @calendars.count + @events.count %>
<% if total_events > 0 %>
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="fas fa-list me-2"></i>
        Eventos do Mês (<%= total_events %>)
      </h5>
    </div>
    <div class="card-body">
      <div class="row">
        <% # Combinar e ordenar todos os eventos por data %>
        <% all_events_grouped = {} %>
        <% @events_by_date.each do |date, events| %>
          <% all_events_grouped[date] ||= [] %>
          <% all_events_grouped[date].concat(events) %>
        <% end %>
        <% @municipal_events_by_date.each do |date, events| %>
          <% all_events_grouped[date] ||= [] %>
          <% all_events_grouped[date].concat(events) %>
        <% end %>
        
        <% all_events_grouped.sort.each do |date, events| %>
          <div class="col-12 mb-3">
            <div class="border-start border-4 border-primary ps-3">
              <h6 class="fw-bold mb-2">
                <i class="fas fa-calendar-day me-2"></i>
                <%= I18n.l(date, format: '%A, %d de %B') %>
                <span class="badge bg-light text-dark ms-2"><%= events.count %> evento(s)</span>
              </h6>
              <div class="row">
                <% events.each do |event| %>
                  <div class="col-md-6 col-lg-4 mb-2">
                    <div class="card border-0 bg-light">
                      <div class="card-body p-3">
                        <% if event.is_a?(Calendar) %>
                          <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0 small"><%= event.title %></h6>
                            <span class="badge bg-<%= case event.calendar_type
                                                      when 'holiday', 'municipal_holiday' then 'danger'
                                                      when 'vacation' then 'success'
                                                      when 'school_start', 'school_end' then 'primary'
                                                      when 'exam_period' then 'warning'
                                                      when 'meeting' then 'purple'
                                                      when 'pedagogical_day', 'teacher_training' then 'secondary'
                                                      when 'event' then 'dark'
                                                      when 'deadline' then 'danger'
                                                      when 'suspension' then 'warning'
                                                      else 'secondary'
                                                      end %>">
                              <%= event.type_description %>
                            </span>
                          </div>
                          <% if event.description.present? %>
                            <p class="card-text text-muted small mb-2">
                              <%= simple_format(truncate(event.description, length: 120)) %>
                            </p>
                          <% end %>
                          <div class="mb-2">
                            <% if event.municipal? %>
                              <span class="badge bg-primary small">
                                <i class="fas fa-building"></i> Municipal
                              </span>
                            <% elsif event.school %>
                              <span class="badge bg-info small">
                                <i class="fas fa-school"></i> <%= truncate(event.school.name, length: 15) %>
                              </span>
                            <% end %>
                            
                            <span class="badge bg-light text-dark small ms-1">
                              <i class="fas fa-calendar-day"></i> <%= event.date.strftime("%d/%m/%Y") %>
                            </span>
                          </div>
                        <% else %>
                          <!-- Evento Municipal -->
                          <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0 small"><%= event.title %></h6>
                            <span class="badge bg-info">
                              <%= event.event_type&.titleize || 'Evento' %>
                            </span>
                          </div>
                          <% if event.description.present? %>
                            <p class="card-text text-muted small mb-2">
                              <%= simple_format(truncate(event.description, length: 120)) %>
                            </p>
                          <% end %>
                          <div class="mb-2">
                            <% if event.municipal? %>
                              <span class="badge bg-primary small">
                                <i class="fas fa-building"></i> Municipal
                              </span>
                            <% elsif event.school %>
                              <span class="badge bg-info small">
                                <i class="fas fa-school"></i> <%= truncate(event.school.name, length: 15) %>
                              </span>
                            <% end %>
                            
                            <span class="badge bg-light text-dark small ms-1">
                              <i class="fas fa-calendar-day"></i> <%= (event.start_date || event.event_date).strftime("%d/%m/%Y") %>
                            </span>
                            
                            <% if event.start_time %>
                              <span class="badge bg-light text-dark small ms-1">
                                <i class="fas fa-clock"></i> <%= event.start_time.strftime("%H:%M") %>
                              </span>
                            <% end %>
                          </div>
                        <% end %>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% else %>
  <div class="card mb-4">
    <div class="card-body text-center py-5">
      <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
      <h5 class="text-muted">Nenhum evento encontrado</h5>
      <p class="text-muted">Não há eventos no calendário acadêmico para este mês.</p>
    </div>
  </div>
<% end %>

<!-- Estatísticas do Mês -->
<div class="row">
  <div class="col-md-3">
    <div class="card text-center border-primary">
      <div class="card-body">
        <i class="fas fa-calendar-check fa-2x text-primary mb-2"></i>
        <h4 class="fw-bold text-primary"><%= @month_stats[:total_events] %></h4>
        <p class="card-text text-muted mb-0">Total de Eventos</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center border-danger">
      <div class="card-body">
        <i class="fas fa-calendar-times fa-2x text-danger mb-2"></i>
        <h4 class="fw-bold text-danger"><%= @month_stats[:holidays] %></h4>
        <p class="card-text text-muted mb-0">Feriados</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center border-success">
      <div class="card-body">
        <i class="fas fa-umbrella-beach fa-2x text-success mb-2"></i>
        <h4 class="fw-bold text-success"><%= @month_stats[:vacations] %></h4>
        <p class="card-text text-muted mb-0">Períodos de Férias</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center border-info">
      <div class="card-body">
        <i class="fas fa-graduation-cap fa-2x text-info mb-2"></i>
        <h4 class="fw-bold text-info"><%= @month_stats[:school_events] %></h4>
        <p class="card-text text-muted mb-0">Eventos Escolares</p>
      </div>
    </div>
  </div>
</div>

<!-- CSS Personalizado para o Calendário -->
<style>
.calendar-grid {
  display: flex;
  flex-direction: column;
  min-height: 500px;
}

.calendar-header {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  background-color: #f8f9fa;
  border-bottom: 1px solid #dee2e6;
}

.calendar-day-header {
  padding: 12px 8px;
  text-align: center;
  font-weight: bold;
  color: #6c757d;
  border-right: 1px solid #dee2e6;
}

.calendar-day-header:last-child {
  border-right: none;
}

.calendar-body {
  flex: 1;
}

.calendar-week {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  min-height: 120px;
}

.calendar-day {
  border-right: 1px solid #dee2e6;
  border-bottom: 1px solid #dee2e6;
  padding: 8px;
  position: relative;
  min-height: 120px;
  background-color: white;
  transition: background-color 0.2s;
}

.calendar-day:hover {
  background-color: #f8f9fa;
}

.calendar-day:last-child {
  border-right: none;
}

.calendar-day.other-month {
  background-color: #f8f9fa;
  color: #adb5bd;
}

.calendar-day.today {
  background-color: #e3f2fd;
  border: 2px solid #2196f3;
}

.calendar-day.has-events {
  background-color: #fff3cd;
}

.day-number {
  font-weight: bold;
  margin-bottom: 4px;
  position: relative;
}

.today-indicator {
  position: absolute;
  top: -2px;
  right: -2px;
  width: 8px;
  height: 8px;
  background-color: #2196f3;
  border-radius: 50%;
}

.day-events {
  margin-top: 4px;
}

.event-item {
  font-size: 10px;
  padding: 2px 4px;
  margin-bottom: 2px;
  border-radius: 3px;
  color: white;
  text-overflow: ellipsis;
  overflow: hidden;
  white-space: nowrap;
  cursor: pointer;
  transition: opacity 0.2s;
}

.event-item:hover {
  opacity: 0.8;
}

.more-events {
  font-size: 9px;
  color: #6c757d;
  font-style: italic;
  text-align: center;
  margin-top: 2px;
}

.bg-purple {
  background-color: #6f42c1 !important;
}

@media (max-width: 768px) {
  .calendar-week {
    min-height: 80px;
  }
  
  .calendar-day {
    min-height: 80px;
    padding: 4px;
  }
  
  .event-item {
    font-size: 8px;
    padding: 1px 2px;
  }
}
</style>

<!-- JavaScript para funcionalidades do calendário -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Inicializar tooltips do Bootstrap
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});
</script>