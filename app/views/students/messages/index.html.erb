<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h4 class="mb-0">
            <i class="fas fa-envelope me-2"></i>
            Minhas Mensagens
          </h4>
          <div>
            <%= link_to new_students_message_path, class: "btn btn-primary" do %>
              <i class="fas fa-plus"></i> Nova Mensagem
            <% end %>
          </div>
        </div>
        
        <div class="card-body">
          <!-- Filtros -->
          <div class="row mb-4">
            <div class="col-md-3">
              <%= form_tag students_messages_path, method: :get, local: true do %>
                <%= select_tag :status, 
                               options_for_select([
                                 ['Todas', ''],
                                 ['Não lidas', 'unread'],
                                 ['Lidas', 'read']
                               ], params[:status]), 
                               { class: "form-select", onchange: "this.form.submit();" } %>
              <% end %>
            </div>
            <div class="col-md-3">
              <%= form_tag students_messages_path, method: :get, local: true do %>
                <%= select_tag :sender_type, 
                               options_for_select([
                                 ['Todas', ''],
                                 ['Professores', 'teacher'],
                                 ['Direção', 'direction'],
                                 ['Administração', 'admin']
                               ], params[:sender_type]), 
                               { class: "form-select", onchange: "this.form.submit();" } %>
              <% end %>
            </div>
            <div class="col-md-6">
              <%= form_tag students_messages_path, method: :get, local: true, class: "d-flex" do %>
                <%= text_field_tag :search, params[:search], 
                                   placeholder: "Buscar mensagens...", 
                                   class: "form-control me-2" %>
                <%= button_tag type: "submit", class: "btn btn-outline-primary" do %>
                  <i class="fas fa-search"></i>
                <% end %>
              <% end %>
            </div>
          </div>

          <!-- Lista de Mensagens -->
          <div class="messages-list">
            <% messages = [
              {
                id: 1,
                sender_name: "Prof. João Silva",
                sender_type: "teacher",
                subject: "Prova de Matemática - Próxima Semana",
                preview: "Prezados alunos, gostaria de informar que a prova de matemática será...",
                sent_at: "2 horas atrás",
                read: false,
                important: true
              },
              {
                id: 2,
                sender_name: "Direção",
                sender_type: "direction",
                subject: "Reunião de Pais - Convocação",
                preview: "Informamos que haverá reunião de pais no próximo sábado às 14h...",
                sent_at: "1 dia atrás",
                read: false,
                important: false
              },
              {
                id: 3,
                sender_name: "Profa. Ana Costa",
                sender_type: "teacher",
                subject: "Material de Apoio - Português",
                preview: "Disponibilizei novos materiais de apoio para a disciplina de português...",
                sent_at: "3 dias atrás",
                read: true,
                important: false
              }
            ] %>

            <% if messages.any? %>
              <div class="list-group">
                <% messages.each do |message| %>
                  <a href="<%= students_message_path(message[:id]) %>" class="list-group-item list-group-item-action <%= 'list-group-item-light' unless message[:read] %>">
                    <div class="d-flex w-100 justify-content-between align-items-start">
                      <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                          <% if message[:important] %>
                            <i class="fas fa-exclamation-circle text-danger me-2"></i>
                          <% end %>
                          
                          <% case message[:sender_type] %>
                          <% when 'teacher' %>
                            <i class="fas fa-chalkboard-teacher text-primary me-2"></i>
                          <% when 'direction' %>
                            <i class="fas fa-user-tie text-warning me-2"></i>
                          <% when 'admin' %>
                            <i class="fas fa-cog text-info me-2"></i>
                          <% end %>
                          
                          <h6 class="mb-0 <%= 'fw-bold' unless message[:read] %>">
                            <%= message[:sender_name] %>
                          </h6>
                          
                          <% unless message[:read] %>
                            <span class="badge bg-primary ms-2">Nova</span>
                          <% end %>
                        </div>
                        
                        <h6 class="mb-1 <%= 'fw-bold' unless message[:read] %>">
                          <%= message[:subject] %>
                        </h6>
                        
                        <p class="mb-1 text-muted">
                          <%= message[:preview] %>
                        </p>
                      </div>
                      
                      <div class="text-end">
                        <small class="text-muted">
                          <i class="fas fa-clock me-1"></i>
                          <%= message[:sent_at] %>
                        </small>
                        <div class="mt-2">
                          <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" onclick="event.stopPropagation();">
                              <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                              <li>
                                <a class="dropdown-item" href="<%= students_message_path(message[:id]) %>">
                                  <i class="fas fa-eye"></i> Visualizar
                                </a>
                              </li>
                              <% unless message[:read] %>
                                <li>
                                  <a class="dropdown-item" href="#" onclick="markAsRead(<%= message[:id] %>); event.preventDefault();">
                                    <i class="fas fa-check"></i> Marcar como lida
                                  </a>
                                </li>
                              <% end %>
                              <li>
                                <a class="dropdown-item" href="#" onclick="replyMessage(<%= message[:id] %>); event.preventDefault();">
                                  <i class="fas fa-reply"></i> Responder
                                </a>
                              </li>
                              <li><hr class="dropdown-divider"></li>
                              <li>
                                <a class="dropdown-item text-danger" href="#" onclick="deleteMessage(<%= message[:id] %>); event.preventDefault();">
                                  <i class="fas fa-trash"></i> Excluir
                                </a>
                              </li>
                            </ul>
                          </div>
                        </div>
                      </div>
                    </div>
                  </a>
                <% end %>
              </div>

              <!-- Paginação -->
              <div class="d-flex justify-content-center mt-4">
                <nav>
                  <ul class="pagination">
                    <li class="page-item disabled">
                      <a class="page-link" href="#">Anterior</a>
                    </li>
                    <li class="page-item active">
                      <a class="page-link" href="#">1</a>
                    </li>
                    <li class="page-item">
                      <a class="page-link" href="#">2</a>
                    </li>
                    <li class="page-item">
                      <a class="page-link" href="#">3</a>
                    </li>
                    <li class="page-item">
                      <a class="page-link" href="#">Próximo</a>
                    </li>
                  </ul>
                </nav>
              </div>
            <% else %>
              <div class="text-center py-5">
                <i class="fas fa-envelope-open fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Nenhuma mensagem encontrada</h5>
                <p class="text-muted">Você não possui mensagens no momento.</p>
                <%= link_to new_students_message_path, class: "btn btn-primary" do %>
                  <i class="fas fa-plus"></i> Enviar Nova Mensagem
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para ações rápidas -->
<div class="modal fade" id="quickActionModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Ação Rápida</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="modalContent"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="confirmAction">Confirmar</button>
      </div>
    </div>
  </div>
</div>

<script>
function markAsRead(messageId) {
  // Implementar marcação como lida via AJAX
  console.log('Marcar como lida:', messageId);
}

function replyMessage(messageId) {
  // Redirecionar para página de resposta
  window.location.href = `/students/messages/${messageId}/reply`;
}

function deleteMessage(messageId) {
  if (confirm('Tem certeza que deseja excluir esta mensagem?')) {
    // Implementar exclusão via AJAX
    console.log('Excluir mensagem:', messageId);
  }
}
</script>