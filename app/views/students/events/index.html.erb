<% content_for :title, "Eventos Escolares" %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><i class="fas fa-calendar"></i> Eventos Escolares</h1>
  <div class="text-muted">
    <small><%= current_user.school.name %></small>
  </div>
</div>

<!-- Filtros -->
<div class="card mb-4">
  <div class="card-body">
    <%= form_with url: students_events_path, method: :get, local: true, class: "row g-3" do |form| %>
      <div class="col-md-3">
        <%= form.select :period, 
                        options_for_select([
                          ['Todos os períodos', ''], 
                          ['Próximos 7 dias', 'week'], 
                          ['Próximos 30 dias', 'month'], 
                          ['Este mês', 'current_month'],
                          ['Eventos passados', 'past']
                        ], params[:period]),
                        {}, { class: "form-select" } %>
      </div>
      <div class="col-md-3">
        <%= form.select :type, 
                        options_for_select([
                          ['Todos os tipos', ''], 
                          ['Acadêmico', 'academic'], 
                          ['Cultural', 'cultural'], 
                          ['Esportivo', 'sports'], 
                          ['Reunião', 'meeting'],
                          ['Feriado', 'holiday']
                        ], params[:type]),
                        {}, { class: "form-select" } %>
      </div>
      <div class="col-md-4">
        <%= form.text_field :search, placeholder: "Buscar eventos...", 
                           value: params[:search], class: "form-control" %>
      </div>
      <div class="col-md-2">
        <div class="d-grid">
          <%= form.submit "Filtrar", class: "btn btn-outline-secondary" %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- Cards de Estatísticas -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card text-center bg-primary text-white">
      <div class="card-body">
        <h3><%= @events.where('start_date >= ?', Date.current).count %></h3>
        <small>Próximos Eventos</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center bg-success text-white">
      <div class="card-body">
        <h3><%= @events.where(start_date: Date.current..Date.current + 7.days).count %></h3>
        <small>Esta Semana</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center bg-info text-white">
      <div class="card-body">
        <h3><%= @events.where(start_date: Date.current.beginning_of_month..Date.current.end_of_month).count %></h3>
        <small>Este Mês</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center bg-warning text-white">
      <div class="card-body">
        <h3><%= @events.count %></h3>
        <small>Total</small>
      </div>
    </div>
  </div>
</div>

<!-- Lista de Eventos -->
<div class="row">
  <% if @events.any? %>
    <% @events.order(:start_date).each do |event| %>
      <div class="col-lg-6 col-md-12 mb-4">
        <div class="card h-100 <%= 'border-warning' if event.start_date == Date.current %>">
          <% if event.start_date == Date.current %>
            <div class="card-header bg-warning text-dark">
              <small><i class="fas fa-star"></i> Evento de Hoje</small>
            </div>
          <% end %>
          
          <div class="card-body">
            <!-- Título e tipo -->
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h6 class="card-title mb-0">
                <i class="fas fa-calendar-check text-primary"></i>
                <%= event.title %>
              </h6>
              <% if event.event_type.present? %>
                <span class="badge bg-<%= case event.event_type
                  when 'academic' then 'primary'
                  when 'cultural' then 'success'
                  when 'sports' then 'warning'
                  when 'meeting' then 'info'
                  when 'holiday' then 'danger'
                  else 'secondary'
                  end %>">
                  <%= event.event_type.humanize %>
                </span>
              <% end %>
            </div>

            <!-- Descrição -->
            <% if event.description.present? %>
              <p class="text-muted small mb-3">
                <%= truncate(event.description, length: 150) %>
              </p>
            <% end %>

            <!-- Data e hora -->
            <div class="mb-3">
              <div class="row">
                <div class="col-6">
                  <small class="text-muted">Data de início:</small>
                  <br>
                  <strong>
                    <%= event.start_date.strftime("%d/%m/%Y") %>
                    <% if event.start_time.present? %>
                      às <%= event.start_time.strftime("%H:%M") %>
                    <% end %>
                  </strong>
                </div>
                <div class="col-6">
                  <small class="text-muted">
                    <% if event.end_date == event.start_date %>
                      <% if event.end_time.present? %>
                        Término:
                      <% else %>
                        Evento de um dia
                      <% end %>
                    <% else %>
                      Data de término:
                    <% end %>
                  </small>
                  <br>
                  <strong>
                    <% if event.end_date != event.start_date %>
                      <%= event.end_date.strftime("%d/%m/%Y") %>
                    <% end %>
                    <% if event.end_time.present? %>
                      <%= event.end_time.strftime("%H:%M") %>
                    <% end %>
                  </strong>
                </div>
              </div>
            </div>

            <!-- Local -->
            <% if event.location.present? %>
              <div class="mb-2">
                <small class="text-muted">Local:</small>
                <br>
                <i class="fas fa-map-marker-alt text-danger"></i>
                <%= event.location %>
              </div>
            <% end %>

            <!-- Status do evento -->
            <div class="mb-2">
              <% if event.start_date > Date.current %>
                <span class="badge bg-success">
                  <i class="fas fa-clock"></i>
                  Em <%= distance_of_time_in_words(Date.current, event.start_date) %>
                </span>
              <% elsif event.start_date == Date.current %>
                <span class="badge bg-warning">
                  <i class="fas fa-star"></i> Hoje
                </span>
              <% elsif event.end_date && event.end_date >= Date.current %>
                <span class="badge bg-info">
                  <i class="fas fa-play"></i> Em andamento
                </span>
              <% else %>
                <span class="badge bg-secondary">
                  <i class="fas fa-check"></i> Finalizado
                </span>
              <% end %>
            </div>

            <!-- Duração do evento -->
            <% if event.end_date && event.end_date != event.start_date %>
              <div class="text-muted small">
                <i class="fas fa-calendar"></i>
                Duração: <%= pluralize((event.end_date - event.start_date).to_i + 1, 'dia') %>
              </div>
            <% end %>
          </div>

          <div class="card-footer">
            <div class="d-flex justify-content-between align-items-center">
              <small class="text-muted">
                <i class="fas fa-user"></i>
                Criado por: <%= event.created_by || 'Administração' %>
              </small>
              <% if event.start_date >= Date.current %>
                <button class="btn btn-sm btn-outline-primary" onclick="addToCalendar('<%= event.title %>', '<%= event.start_date %>', '<%= event.end_date %>')">
                  <i class="fas fa-calendar-plus"></i> Adicionar
                </button>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% else %>
    <div class="col-12">
      <div class="card">
        <div class="card-body text-center py-5">
          <i class="fas fa-calendar fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">Nenhum evento encontrado</h5>
          <p class="text-muted">
            Não há eventos programados no momento ou nenhum evento corresponde aos filtros selecionados.
          </p>
        </div>
      </div>
    </div>
  <% end %>
</div>

<!-- Próximos eventos em destaque -->
<% upcoming_events = @events.where('start_date >= ?', Date.current).limit(3) %>
<% if upcoming_events.any? && params[:period] != 'past' %>
  <div class="card mt-4">
    <div class="card-header">
      <h5><i class="fas fa-calendar-check"></i> Próximos Eventos em Destaque</h5>
    </div>
    <div class="card-body">
      <div class="timeline">
        <% upcoming_events.each do |event| %>
          <div class="timeline-item">
            <div class="timeline-marker bg-primary">
              <i class="fas fa-calendar text-white"></i>
            </div>
            <div class="timeline-content">
              <h6 class="mb-1"><%= event.title %></h6>
              <p class="text-muted small mb-1">
                <%= event.start_date.strftime("%d/%m/%Y") %>
                <% if event.start_time.present? %>
                  às <%= event.start_time.strftime("%H:%M") %>
                <% end %>
                <% if event.location.present? %>
                  - <%= event.location %>
                <% end %>
              </p>
              <% if event.description.present? %>
                <p class="text-muted small mb-0">
                  <%= truncate(event.description, length: 100) %>
                </p>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<script>
function addToCalendar(title, startDate, endDate) {
  // Funcionalidade para adicionar evento ao calendário do dispositivo
  if (navigator.share) {
    navigator.share({
      title: title,
      text: `Evento: ${title}\nData: ${startDate}${endDate !== startDate ? ` até ${endDate}` : ''}`,
      url: window.location.href
    });
  } else {
    // Fallback para criar um arquivo .ics
    const event = {
      title: title,
      start: startDate,
      end: endDate || startDate,
      description: 'Evento da escola'
    };
    
    alert('Adicionar ao calendário: ' + title + ' em ' + startDate);
  }
}
</script>

<style>
.timeline {
  position: relative;
  padding-left: 2rem;
}

.timeline-item {
  position: relative;
  padding-bottom: 1.5rem;
}

.timeline-item:not(:last-child)::before {
  content: '';
  position: absolute;
  left: -1.625rem;
  top: 2rem;
  width: 2px;
  height: calc(100% - 1rem);
  background-color: #dee2e6;
}

.timeline-marker {
  position: absolute;
  left: -2rem;
  top: 0;
  width: 2rem;
  height: 2rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.timeline-content {
  margin-left: 0.5rem;
}
</style>
                  <% if event.start_time.present? %>
                    <i class="fas fa-clock"></i>
                    <%= event.start_time.strftime("%H:%M") %>
                    <% if event.end_time.present? %>
                      - <%= event.end_time.strftime("%H:%M") %>
                    <% end %>
                    <br>
                  <% end %>
                  <% if event.location.present? %>
                    <i class="fas fa-map-marker-alt"></i>
                    <%= event.location %>
                  <% end %>
                </div>
              </div>
              <% if event.description.length > 100 %>
                <div class="card-footer">
                  <button class="btn btn-sm btn-outline-primary" 
                          data-bs-toggle="collapse" 
                          data-bs-target="#event-<%= event.id %>" 
                          aria-expanded="false">
                    Ver mais
                  </button>
                  <div class="collapse mt-2" id="event-<%= event.id %>">
                    <%= simple_format(event.description) %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Calendário de Eventos -->
      <div class="row mt-4">
        <div class="col-12">
          <h4>Calendário do Mês</h4>
          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-bordered table-sm">
                  <thead>
                    <tr class="table-light">
                      <th>Dom</th>
                      <th>Seg</th>
                      <th>Ter</th>
                      <th>Qua</th>
                      <th>Qui</th>
                      <th>Sex</th>
                      <th>Sáb</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Aqui seria implementado o calendário -->
                    <tr>
                      <td colspan="7" class="text-center text-muted">
                        Calendário em desenvolvimento
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% else %>
      <div class="alert alert-info">
        <i class="fas fa-info-circle"></i>
        Não há eventos programados no momento.
      </div>
    <% end %>
  </div>
</div>
