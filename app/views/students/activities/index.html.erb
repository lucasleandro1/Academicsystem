<% content_for :title, "Atividades" %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><i class="fas fa-tasks"></i> Minhas Atividades</h1>
  <div class="text-muted">
    <small>Turma: <%= current_user.enrollments.where(status: 'active').first&.classroom&.name || "Não matriculado" %></small>
  </div>
</div>

<!-- Filtros -->
<div class="card mb-4">
  <div class="card-body">
    <%= form_with url: students_activities_path, method: :get, local: true, class: "row g-3" do |form| %>
      <div class="col-md-3">
        <%= form.select :subject_id, 
                        options_from_collection_for_select(@subjects, :id, :name, params[:subject_id]),
                        { prompt: "Todas as disciplinas" }, { class: "form-select" } %>
      </div>
      <div class="col-md-3">
        <%= form.select :status, 
                        options_for_select([
                          ['Todas', ''], 
                          ['Pendentes', 'pending'], 
                          ['Entregues', 'submitted'], 
                          ['Vencidas', 'overdue']
                        ], params[:status]),
                        {}, { class: "form-select" } %>
      </div>
      <div class="col-md-4">
        <%= form.text_field :search, placeholder: "Buscar por título...", 
                           value: params[:search], class: "form-control" %>
      </div>
      <div class="col-md-2">
        <div class="d-grid">
          <%= form.submit "Filtrar", class: "btn btn-outline-secondary" %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- Estatísticas Rápidas -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h3 class="text-primary"><%= @activities.count %></h3>
        <small class="text-muted">Total de Atividades</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h3 class="text-warning"><%= @pending_activities %></h3>
        <small class="text-muted">Pendentes</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h3 class="text-success"><%= @submitted_activities %></h3>
        <small class="text-muted">Entregues</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h3 class="text-danger"><%= @overdue_activities %></h3>
        <small class="text-muted">Vencidas</small>
      </div>
    </div>
  </div>
</div>

<!-- Lista de Atividades -->
<div class="row">
  <% if @activities.any? %>
    <% @activities.each do |activity| %>
      <% submission = activity.submissions.find_by(user: current_user) %>
      <div class="col-lg-6 col-md-12 mb-4">
        <div class="card h-100 <%= 'border-success' if submission&.grade.present? %>">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
              <i class="fas fa-tasks text-primary"></i> 
              <%= activity.title %>
            </h6>
            <div class="d-flex gap-1">
              <% if submission %>
                <% if submission.grade.present? %>
                  <span class="badge bg-success">Corrigida</span>
                <% else %>
                  <span class="badge bg-info">Entregue</span>
                <% end %>
              <% elsif activity.due_date < Date.current %>
                <span class="badge bg-danger">Vencida</span>
              <% elsif activity.due_date <= Date.current + 3.days %>
                <span class="badge bg-warning">Próximo Vencimento</span>
              <% else %>
                <span class="badge bg-primary">Pendente</span>
              <% end %>
            </div>
          </div>
          <div class="card-body">
            <!-- Informações básicas -->
            <div class="mb-2">
              <small class="text-muted">Disciplina:</small>
              <br>
              <span class="badge bg-primary"><%= activity.subject.name %></span>
              <br>
              <small class="text-muted">Professor: <%= activity.teacher.full_name %></small>
            </div>

            <div class="mb-3">
              <small class="text-muted">Descrição:</small>
              <p class="text-muted small mb-0">
                <%= simple_format(activity.description) %>
              </p>
            </div>

            <!-- Datas importantes -->
            <div class="row mb-2">
              <div class="col-6">
                <small class="text-muted">Criada em:</small>
                <br>
                <small><%= activity.created_at.strftime("%d/%m/%Y") %></small>
              </div>
              <div class="col-6">
                <small class="text-muted">Prazo:</small>
                <br>
                <small class="<%= 'text-danger' if activity.due_date < Date.current %>">
                  <%= activity.due_date.strftime("%d/%m/%Y") %>
                  <% if activity.due_date >= Date.current %>
                    <br>
                    <span class="text-muted">
                      (<%= distance_of_time_in_words(Date.current, activity.due_date) %> restantes)
                    </span>
                  <% end %>
                </small>
              </div>
            </div>

            <!-- Anexos da atividade -->
            <% if activity.attachments.any? %>
              <div class="mb-2">
                <small class="text-muted">Anexos:</small>
                <br>
                <% activity.attachments.each do |attachment| %>
                  <%= link_to attachment.file_name, attachment.file_url, 
                             class: "btn btn-sm btn-outline-secondary me-1 mb-1", 
                             target: "_blank" do %>
                    <i class="fas fa-paperclip"></i> <%= attachment.file_name %>
                  <% end %>
                <% end %>
              </div>
            <% end %>

            <!-- Status da submissão -->
            <% if submission %>
              <div class="border rounded p-2 bg-light">
                <small class="text-muted">Sua entrega:</small>
                <br>
                <small>
                  <i class="fas fa-clock"></i> Entregue em <%= submission.submitted_at.strftime("%d/%m/%Y às %H:%M") %>
                </small>
                <% if submission.grade.present? %>
                  <br>
                  <strong class="text-success">
                    <i class="fas fa-star"></i> Nota: <%= submission.grade %>
                  </strong>
                  <% if submission.feedback.present? %>
                    <br>
                    <small class="text-muted">Feedback: <%= submission.feedback %></small>
                  <% end %>
                <% else %>
                  <br>
                  <small class="text-warning">
                    <i class="fas fa-clock"></i> Aguardando correção
                  </small>
                <% end %>
              </div>
            <% end %>
          </div>
          <div class="card-footer">
            <div class="d-grid gap-2">
              <% if submission %>
                <%= link_to students_activity_path(activity), class: "btn btn-outline-primary" do %>
                  <i class="fas fa-eye"></i> Ver Detalhes e Entrega
                <% end %>
              <% elsif activity.due_date >= Date.current %>
                <%= link_to students_activity_path(activity), class: "btn btn-primary" do %>
                  <i class="fas fa-upload"></i> Enviar Resposta
                <% end %>
              <% else %>
                <%= link_to students_activity_path(activity), class: "btn btn-outline-secondary" do %>
                  <i class="fas fa-eye"></i> Ver Atividade (Vencida)
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% else %>
    <div class="col-12">
      <div class="card">
        <div class="card-body text-center py-5">
          <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">Nenhuma atividade encontrada</h5>
          <p class="text-muted">
            Não há atividades disponíveis no momento ou nenhuma atividade corresponde aos filtros selecionados.
          </p>
        </div>
      </div>
    </div>
  <% end %>
</div>

<!-- Paginação -->
<% if @activities.respond_to?(:current_page) %>
  <div class="d-flex justify-content-center mt-4">
    <%= paginate @activities %>
  </div>
<% end %>
