<% content_for :title, "Notas e Boletim" %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><i class="fas fa-star"></i> Minhas Notas e Boletim</h1>
  <div>
    <% if current_user.classroom&.class_schedules&.any? && current_user.student_grades.any? %>
      <%= link_to generate_report_card_students_documents_path, class: "btn btn-success me-2",
                  title: "Baixar boletim completo em PDF" do %>
        <i class="fas fa-file-pdf"></i> Baixar Boletim PDF
      <% end %>
    <% else %>
      <button class="btn btn-outline-secondary me-2" disabled 
              title="Boletim será gerado quando houver notas lançadas">
        <i class="fas fa-file-pdf"></i> Baixar Boletim PDF
      </button>
    <% end %>
    <div class="text-muted d-inline">
      <small>Ano letivo: <%= Date.current.year %></small>
    </div>
  </div>
</div>

<!-- Resumo Geral -->
<% if current_user.classroom %>
  <div class="alert alert-info mb-4">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h6 class="mb-1">
          <i class="fas fa-graduation-cap"></i> 
          Turma: <strong><%= current_user.classroom.name %></strong>
        </h6>
        <small>
          <%= current_user.classroom.level.humanize %> - 
          <%= current_user.classroom.shift.humanize %> - 
          ID: <%= current_user.id %>
        </small>
      </div>
      <div class="col-md-4 text-end">
        <h4 class="mb-0 text-primary"><%= @overall_average || "N/A" %></h4>
        <small class="text-muted">Média Geral</small>
      </div>
    </div>
  </div>

  <!-- Tabela de Notas -->
  <div class="card">
    <div class="card-body">
      <h5 class="card-title">
        <i class="fas fa-chart-line"></i> Boletim Detalhado
      </h5>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-light">
            <tr>
              <th>Disciplina</th>
              <th>Professor</th>
              <% @grade_types.each do |grade_type| %>
                <th><%= grade_type.humanize %></th>
              <% end %>
              <th>Média</th>
              <th>Situação</th>
            </tr>
          </thead>
            <tbody>
              <% if current_user.classroom&.class_schedules&.any? %>
                <% subjects_from_schedules = current_user.classroom.class_schedules.includes(:subject).map(&:subject).uniq %>
                <% subjects_from_schedules.each do |subject| %>
                  <tr>
                    <td><%= subject.name %></td>
                    <td><%= subject.user.full_name %></td>
                    <% @grade_types.each_with_index do |grade_type, index| %>
                      <% bimester = index + 1 %>
                      <% grade_average = @grades_by_subject[subject]&.dig(bimester) %>
                      <td>
                        <% if grade_average %>
                          <span class="badge bg-<%= grade_average >= 7 ? 'success' : grade_average >= 5 ? 'warning' : 'danger' %>">
                            <%= number_with_precision(grade_average, precision: 1) %>
                          </span>
                        <% else %>
                          <span class="text-muted">-</span>
                        <% end %>
                      </td>
                    <% end %>
                    <% subject_grades = current_user.student_grades.where(subject: subject) %>
                    <% average = subject_grades.any? ? subject_grades.average(:value) : nil %>
                    <td>
                      <% if average %>
                        <strong class="text-<%= average >= 7 ? 'success' : average >= 5 ? 'warning' : 'danger' %>">
                          <%= number_with_precision(average, precision: 1) %>
                        </strong>
                      <% else %>
                        <span class="text-muted">-</span>
                      <% end %>
                    </td>
                    <td>
                      <% if average %>
                        <span class="badge bg-<%= average >= 7 ? 'success' : average >= 5 ? 'warning' : 'danger' %>">
                          <%= average >= 7 ? 'Aprovado' : average >= 5 ? 'Recuperação' : 'Reprovado' %>
                        </span>
                      <% else %>
                        <span class="badge bg-secondary">Em andamento</span>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              <% else %>
                <tr>
                  <td colspan="<%= @grade_types.size + 4 %>" class="text-center text-muted">
                    Você não está matriculado em nenhuma turma ou sua turma não possui horários de aula cadastrados.
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
<% else %>
  <div class="alert alert-info">
    <i class="fas fa-info-circle"></i>
    Você ainda não está matriculado em nenhuma disciplina.
  </div>
<% end %>
