<% content_for :title, "Notas e Boletim" %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><i class="fas fa-star"></i> Minhas Notas e Boletim</h1>
  <div class="text-muted">
    <small>Ano letivo: <%= Date.current.year %></small>
  </div>
</div>

<!-- Resumo Geral -->
<% enrollment = current_user.enrollments.where(status: 'active').first %>
<% if enrollment&.classroom %>
  <div class="alert alert-info mb-4">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h6 class="mb-1">
          <i class="fas fa-graduation-cap"></i> 
          Turma: <strong><%= enrollment.classroom.name %></strong>
        </h6>
        <small>
          <%= enrollment.classroom.level.humanize %> - 
          <%= enrollment.classroom.shift.humanize %> - 
          Matrícula: <%= current_user.registration_number %>
        </small>
      </div>
      <div class="col-md-4 text-end">
        <h4 class="mb-0 text-primary"><%= @overall_average || "N/A" %></h4>
        <small class="text-muted">Média Geral</small>
      </div>
    </div>
  </div>
<% end %>
            <tr>
              <th>Disciplina</th>
              <th>Professor</th>
              <th>Nota 1</th>
              <th>Nota 2</th>
              <th>Nota 3</th>
              <th>Nota 4</th>
              <th>Média</th>
              <th>Situação</th>
            </tr>
          </thead>
          <tbody>
            <% @enrollments.each do |enrollment| %>
              <tr>
                <td><%= enrollment.subject.name %></td>
                <td><%= enrollment.subject.user.full_name %></td>
                <% @grade_types.each do |grade_type| %>
                  <% grade = enrollment.grades.find_by(grade_type: grade_type) %>
                  <td>
                    <% if grade %>
                      <span class="badge bg-<%= grade.value >= 7 ? 'success' : grade.value >= 5 ? 'warning' : 'danger' %>">
                        <%= grade.value %>
                      </span>
                    <% else %>
                      <span class="text-muted">-</span>
                    <% end %>
                  </td>
                <% end %>
                <% average = calculate_average(enrollment) %>
                <td>
                  <% if average %>
                    <strong class="text-<%= average >= 7 ? 'success' : average >= 5 ? 'warning' : 'danger' %>">
                      <%= number_with_precision(average, precision: 1) %>
                    </strong>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td>
                  <% if average %>
                    <span class="badge bg-<%= average >= 7 ? 'success' : average >= 5 ? 'warning' : 'danger' %>">
                      <%= average >= 7 ? 'Aprovado' : average >= 5 ? 'Recuperação' : 'Reprovado' %>
                    </span>
                  <% else %>
                    <span class="badge bg-secondary">Em andamento</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="alert alert-info">
        <i class="fas fa-info-circle"></i>
        Você ainda não está matriculado em nenhuma disciplina.
      </div>
    <% end %>
  </div>
</div>
