<% content_for :title, "Atividades" %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><i class="fas fa-tasks"></i> Minhas Atividades</h1>
  <%= link_to new_teachers_activity_path, class: "btn btn-primary" do %>
    <i class="fas fa-plus"></i> Nova Atividade
  <% end %>
</div>

<!-- Filtros -->
<div class="card mb-4">
  <div class="card-body">
    <%= form_with url: teachers_activities_path, method: :get, local: true, class: "row g-3" do |form| %>
      <div class="col-md-3">
        <%= form.select :subject_id, 
                        options_from_collection_for_select(current_user.teacher_subjects, :id, :name, params[:subject_id]),
                        { prompt: "Todas as disciplinas" }, { class: "form-select" } %>
      </div>
      <div class="col-md-3">
        <%= form.select :status, 
                        options_for_select([
                          ['Todas', ''], 
                          ['Ativas', 'active'], 
                          ['Vencidas', 'overdue'], 
                          ['Finalizadas', 'finished']
                        ], params[:status]),
                        {}, { class: "form-select" } %>
      </div>
      <div class="col-md-4">
        <%= form.text_field :search, placeholder: "Buscar por título ou descrição...", 
                           value: params[:search], class: "form-control" %>
      </div>
      <div class="col-md-2">
        <div class="d-grid">
          <%= form.submit "Filtrar", class: "btn btn-outline-secondary" %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- Estatísticas Rápidas -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h3 class="text-primary"><%= @activities.count %></h3>
        <small class="text-muted">Total de Atividades</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h3 class="text-success"><%= @activities.where('due_date >= ?', Date.current).count %></h3>
        <small class="text-muted">Ativas</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h3 class="text-warning"><%= @pending_corrections %></h3>
        <small class="text-muted">Aguardando Correção</small>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center">
      <div class="card-body">
        <h3 class="text-danger"><%= @activities.where('due_date < ?', Date.current).count %></h3>
        <small class="text-muted">Vencidas</small>
      </div>
    </div>
  </div>
</div>

<!-- Lista de Atividades -->
<div class="row">
  <% if @activities.any? %>
    <% @activities.each do |activity| %>
      <div class="col-lg-6 col-md-12 mb-4">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
              <i class="fas fa-tasks text-primary"></i> 
              <%= activity.title %>
            </h6>
            <div class="d-flex gap-1">
              <% if activity.due_date < Date.current %>
                <span class="badge bg-danger">Vencida</span>
              <% elsif activity.due_date <= Date.current + 3.days %>
                <span class="badge bg-warning">Próximo Vencimento</span>
              <% else %>
                <span class="badge bg-success">Ativa</span>
              <% end %>
            </div>
          </div>
          <div class="card-body">
            <!-- Informações básicas -->
            <div class="mb-2">
              <small class="text-muted">Disciplina:</small>
              <br>
              <span class="badge bg-primary"><%= activity.subject.name %></span>
              <span class="badge bg-info"><%= activity.subject.classroom.name %></span>
            </div>

            <div class="mb-2">
              <small class="text-muted">Descrição:</small>
              <p class="text-muted small mb-0">
                <%= truncate(activity.description, length: 100) %>
              </p>
            </div>

            <!-- Datas importantes -->
            <div class="row mb-2">
              <div class="col-6">
                <small class="text-muted">Criada em:</small>
                <br>
                <small><%= activity.created_at.strftime("%d/%m/%Y") %></small>
              </div>
              <div class="col-6">
                <small class="text-muted">Prazo:</small>
                <br>
                <small class="<%= 'text-danger' if activity.due_date < Date.current %>">
                  <%= activity.due_date.strftime("%d/%m/%Y") %>
                </small>
              </div>
            </div>

            <!-- Estatísticas de submissões -->
            <% total_students = activity.subject.students.where(active: true).count %>
            <% submitted_count = activity.submissions.count %>
            <% corrected_count = activity.submissions.where.not(grade: nil).count %>
            
            <div class="progress mb-2" style="height: 20px;">
              <% submitted_percentage = total_students > 0 ? (submitted_count.to_f / total_students * 100).round : 0 %>
              <% corrected_percentage = submitted_count > 0 ? (corrected_count.to_f / submitted_count * 100).round : 0 %>
              
              <div class="progress-bar bg-info" style="width: <%= submitted_percentage %>%">
                <%= submitted_count %>/<%= total_students %> entregues
              </div>
            </div>
            
            <div class="row text-center">
              <div class="col-4">
                <small class="text-muted">Entregues</small>
                <br>
                <strong class="text-info"><%= submitted_count %>/<%= total_students %></strong>
              </div>
              <div class="col-4">
                <small class="text-muted">Corrigidas</small>
                <br>
                <strong class="text-success"><%= corrected_count %>/<%= submitted_count %></strong>
              </div>
              <div class="col-4">
                <small class="text-muted">Pendentes</small>
                <br>
                <strong class="text-warning"><%= submitted_count - corrected_count %></strong>
              </div>
            </div>
          </div>
          <div class="card-footer">
            <div class="row g-1">
              <div class="col-4">
                <%= link_to teachers_activity_path(activity), class: "btn btn-sm btn-outline-primary w-100" do %>
                  <i class="fas fa-eye"></i> Ver
                <% end %>
              </div>
              <div class="col-4">
                <%= link_to edit_teachers_activity_path(activity), class: "btn btn-sm btn-outline-secondary w-100" do %>
                  <i class="fas fa-edit"></i> Editar
                <% end %>
              </div>
              <div class="col-4">
                <%= link_to teachers_activity_submissions_path(activity), class: "btn btn-sm btn-outline-success w-100" do %>
                  <i class="fas fa-check"></i> Correções
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% else %>
    <div class="col-12">
      <div class="card">
        <div class="card-body text-center py-5">
          <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">Nenhuma atividade encontrada</h5>
          <p class="text-muted">Crie a primeira atividade para suas turmas.</p>
          <%= link_to new_teachers_activity_path, class: "btn btn-primary" do %>
            <i class="fas fa-plus"></i> Criar Atividade
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
</div>

<!-- Paginação -->
<% if @activities.respond_to?(:current_page) %>
  <div class="d-flex justify-content-center mt-4">
    <%= paginate @activities %>
  </div>
<% end %>
