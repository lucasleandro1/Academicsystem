<% content_for :title, "Nova Mensagem" %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><i class="fas fa-plus"></i> Nova Mensagem</h1>
  <%= link_to teachers_messages_path, class: "btn btn-outline-secondary" do %>
    <i class="fas fa-arrow-left"></i> Voltar
  <% end %>
</div>

<div class="row">
  <div class="col-md-8">
    <div class="card">
      <div class="card-body">
        <%= form_with model: [:teachers, @message], local: true do |form| %>
          <% if @message.errors.any? %>
            <div class="alert alert-danger">
              <h6>Erro ao enviar mensagem:</h6>
              <ul class="mb-0">
                <% @message.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              </ul>
            </div>
          <% end %>

          <div class="mb-3">
            <%= form.label :recipient_id, "Destinatário", class: "form-label" %>
            <i class="fas fa-info-circle text-muted" 
               data-bs-toggle="tooltip" 
               title="Use os filtros abaixo para facilitar a busca do destinatário"></i>
            
            <!-- Filtros para facilitar a seleção -->
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="user_type_filter" class="form-label small">Tipo de Usuário</label>
                    <select id="user_type_filter" class="form-select form-select-sm">
                      <option value="">Todos os tipos</option>
                      <option value="direction">Direção</option>
                      <option value="teacher">Professores</option>
                      <option value="student">Alunos</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label for="classroom_filter" class="form-label small">Turma (apenas alunos)</label>
                    <select id="classroom_filter" class="form-select form-select-sm" disabled>
                      <option value="">Todas as turmas</option>
                      <% current_user.teacher_classrooms.order(:name).each do |classroom| %>
                        <option value="<%= classroom.id %>"><%= classroom.name %></option>
                      <% end %>
                    </select>
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col-12">
                    <button type="button" id="clear_filters" class="btn btn-outline-secondary btn-sm">
                      <i class="fas fa-times"></i> Limpar Filtros
                    </button>
                  </div>
                </div>
            
            <% grouped_options = recipient_options_grouped(current_user) %>
            <% if grouped_options.any? %>
              <%= form.select :recipient_id, 
                             grouped_options_for_select(grouped_options), 
                             { prompt: "Selecione o destinatário..." }, 
                             { class: "form-select recipient-select", required: true } %>
            <% else %>
              <div class="alert alert-info mt-2">
                <i class="fas fa-info-circle"></i>
                Não há destinatários disponíveis. Verifique se você tem turmas atribuídas.
              </div>
            <% end %>
            
            <!-- Contador de resultados -->
            <small class="text-muted mt-1 d-block">
              <span id="recipient_count">Carregando destinatários...</span>
            </small>
          </div>

          <div class="mb-3">
            <%= form.label :subject, "Assunto", class: "form-label" %>
            <%= form.text_field :subject, class: "form-control", placeholder: "Assunto da mensagem" %>
          </div>

          <div class="mb-3">
            <%= form.label :body, "Mensagem", class: "form-label" %>
            <%= form.text_area :body, class: "form-control", rows: 6, placeholder: "Digite sua mensagem..." %>
          </div>

          <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <%= link_to teachers_messages_path, class: "btn btn-outline-secondary" do %>
              <i class="fas fa-times"></i> Cancelar
            <% end %>
            <%= form.submit "Enviar Mensagem", class: "btn btn-primary" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <!-- Envio em Lote -->
    <% broadcast_opts = broadcast_options(current_user) %>
    <% if broadcast_opts.any? %>
      <div class="card mb-3">
        <div class="card-header">
          <h6><i class="fas fa-users"></i> Envio em Lote</h6>
        </div>
        <div class="card-body">
          <p class="small">Envie mensagens para grupos específicos:</p>
          
          <% broadcast_opts.each do |option| %>
            <div class="mb-2">
              <button type="button" 
                      class="btn btn-outline-<%= option[:color] %> w-100 broadcast-trigger" 
                      data-key="<%= option[:key] %>"
                      data-title="<%= option[:title] %>"
                      data-description="<%= option[:description] %>">
                <i class="<%= option[:icon] %>"></i> <%= option[:title] %>
              </button>
            </div>
          <% end %>
          
          <% if broadcast_opts.any? { |opt| opt[:key] == 'by_classroom' } %>
            <div class="mt-3">
              <label class="form-label small">Turma específica:</label>
              <select class="form-select form-select-sm" id="classroom-select">
                <option value="">Selecione uma turma</option>
                <% classrooms_for_broadcast(current_user).each do |classroom| %>
                  <option value="<%= classroom.id %>"><%= classroom.display_name %></option>
                <% end %>
              </select>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Modelos de Mensagem -->
    <div class="card">
      <div class="card-header">
        <h6><i class="fas fa-file-alt"></i> Modelos Rápidos</h6>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <button type="button" class="btn btn-sm btn-outline-secondary template-btn" 
                  data-subject="Convocação para Conversa" 
                  data-content="Prezado(a) aluno(a) e responsáveis,

Gostaria de solicitar uma conversa para discutirmos o desempenho acadêmico e comportamento em sala de aula.

Por favor, entrem em contato para agendarmos um horário.

Atenciosamente,
Prof. <%= current_user.full_name %>">
            Convocação
          </button>
          
          <button type="button" class="btn btn-sm btn-outline-secondary template-btn"
                  data-subject="Parabenização pelo Desempenho"
                  data-content="Prezado(a) aluno(a),

Gostaria de parabenizá-lo(a) pelo excelente desempenho demonstrado nas últimas atividades. Continue assim!

Seu esforço e dedicação são notáveis e servem de exemplo para os demais colegas.

Parabéns!
Prof. <%= current_user.full_name %>">
            Parabenização
          </button>
          
          <button type="button" class="btn btn-sm btn-outline-secondary template-btn"
                  data-subject="Lembrete de Atividade"
                  data-content="Prezado(a) aluno(a),

Este é um lembrete sobre a atividade pendente de entrega. 

Não esqueça do prazo estabelecido. Em caso de dúvidas, não hesite em me procurar.

Atenciosamente,
Prof. <%= current_user.full_name %>">
            Lembrete
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Envio em Lote -->
<div class="modal fade" id="bulkMessageModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Enviar Mensagem em Lote</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="bulk-message-form">
          <div class="mb-3">
            <label class="form-label">Assunto:</label>
            <input type="text" class="form-control" id="bulk-subject" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Mensagem:</label>
            <textarea class="form-control" id="bulk-content" rows="4" required></textarea>
          </div>
          <div id="bulk-recipients"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="send-bulk-message">Enviar</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // ==== FILTRO DE DESTINATÁRIOS ====
  const recipientSelect = document.querySelector('.recipient-select');
  const userTypeFilter = document.getElementById('user_type_filter');
  const classroomFilter = document.getElementById('classroom_filter');
  const clearFiltersBtn = document.getElementById('clear_filters');
  const recipientCount = document.getElementById('recipient_count');
  
  // Armazenar todas as opções originais
  const allGroups = [];
  
  // Função para salvar opções originais
  function saveOriginalOptions() {
    if (recipientSelect) {
      const optgroups = recipientSelect.querySelectorAll('optgroup');
      optgroups.forEach(optgroup => {
        const groupData = {
          label: optgroup.label,
          options: []
        };
        
        const options = optgroup.querySelectorAll('option');
        options.forEach(option => {
          if (option.value) { // Ignorar o prompt
            groupData.options.push({
              value: option.value,
              text: option.textContent,
              userType: option.getAttribute('data-user-type') || '',
              classroomId: option.getAttribute('data-classroom-id') || '',
              classroomName: option.getAttribute('data-classroom-name') || ''
            });
          }
        });
        
        if (groupData.options.length > 0) {
          allGroups.push(groupData);
        }
      });
      
      updateRecipientCount();
    }
  }
  
  // Função para atualizar contador
  function updateRecipientCount() {
    if (!recipientSelect || !recipientCount) return;
    
    const visibleOptions = recipientSelect.querySelectorAll('optgroup option').length;
    recipientCount.textContent = `${visibleOptions} destinatário(s) disponível(is)`;
  }
  
  // Função para filtrar destinatários
  function filterRecipients() {
    if (!recipientSelect) return;
    
    const selectedUserType = userTypeFilter?.value || '';
    const selectedClassroomId = classroomFilter?.value || '';
    
    // Preservar o prompt
    const promptOption = recipientSelect.querySelector('option[value=""]');
    recipientSelect.innerHTML = '';
    if (promptOption) {
      recipientSelect.appendChild(promptOption);
    }
    
    // Aplicar filtros
    allGroups.forEach(group => {
      const filteredOptions = group.options.filter(option => {
        // Filtro por tipo de usuário
        if (selectedUserType && option.userType !== selectedUserType) {
          return false;
        }
        
        // Filtro por turma (apenas para alunos)
        if (selectedClassroomId && option.userType === 'student' && option.classroomId !== selectedClassroomId) {
          return false;
        }
        
        return true;
      });
      
      // Se há opções após o filtro, adicionar o grupo
      if (filteredOptions.length > 0) {
        const optgroup = document.createElement('optgroup');
        optgroup.label = group.label;
        
        filteredOptions.forEach(optionData => {
          const option = document.createElement('option');
          option.value = optionData.value;
          option.textContent = optionData.text;
          option.setAttribute('data-user-type', optionData.userType);
          option.setAttribute('data-classroom-id', optionData.classroomId);
          option.setAttribute('data-classroom-name', optionData.classroomName);
          optgroup.appendChild(option);
        });
        
        recipientSelect.appendChild(optgroup);
      }
    });
    
    updateRecipientCount();
  }
  
  // Event listeners para filtros
  if (userTypeFilter) {
    userTypeFilter.addEventListener('change', function() {
      // Habilitar/desabilitar filtro de turma
      if (classroomFilter) {
        classroomFilter.disabled = this.value !== 'student';
        if (this.value !== 'student') {
          classroomFilter.value = '';
        }
      }
      filterRecipients();
    });
  }
  
  if (classroomFilter) {
    classroomFilter.addEventListener('change', filterRecipients);
  }
  
  if (clearFiltersBtn) {
    clearFiltersBtn.addEventListener('click', function() {
      if (userTypeFilter) userTypeFilter.value = '';
      if (classroomFilter) {
        classroomFilter.value = '';
        classroomFilter.disabled = true;
      }
      filterRecipients();
    });
  }
  
  // Inicializar filtros
  saveOriginalOptions();

  // ==== FUNCIONALIDADES EXISTENTES ====
  // Modelos rápidos
  document.querySelectorAll('.template-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const subjectField = document.getElementById('message_subject');
      const contentField = document.getElementById('message_body');
      
      if (subjectField) subjectField.value = this.dataset.subject;
      if (contentField) contentField.value = this.dataset.content;
    });
  });

  // Broadcast triggers
  document.querySelectorAll('.broadcast-trigger').forEach(btn => {
    btn.addEventListener('click', function() {
      const type = this.dataset.key;
      const title = this.dataset.title;
      const modal = document.getElementById('bulkMessageModal');
      
      if (type === 'by_classroom') {
        const classroomSelect = document.getElementById('classroom-select');
        const classroomId = classroomSelect?.value;
        if (!classroomId) {
          alert('Selecione uma turma primeiro');
          return;
        }
        
        document.getElementById('bulk-recipients').innerHTML = 
          '<p><strong>Destinatários:</strong> Todos os alunos da turma selecionada</p>';
        
        modal.dataset.type = 'classroom';
        modal.dataset.id = classroomId;
      } else if (type === 'my_students') {
        document.getElementById('bulk-recipients').innerHTML = 
          '<p><strong>Destinatários:</strong> Todos os seus alunos</p>';
        
        modal.dataset.type = 'my_students';
      }
      
      new bootstrap.Modal(modal).show();
    });
  });

  // Enviar mensagem em lote
  const sendBulkBtn = document.getElementById('send-bulk-message');
  if (sendBulkBtn) {
    sendBulkBtn.addEventListener('click', function() {
      const modal = document.getElementById('bulkMessageModal');
      const type = modal.dataset.type;
      const id = modal.dataset.id;
      const subject = document.getElementById('bulk-subject')?.value;
      const content = document.getElementById('bulk-content')?.value;

      if (!subject || !content) {
        alert('Preencha todos os campos');
        return;
      }

      let url = '';
      let data = { subject: subject, body: content };

      if (type === 'classroom') {
        url = '/teachers/messages/broadcast_to_classroom';
        data.classroom_id = id;
      } else if (type === 'my_students') {
        url = '/teachers/messages/broadcast_to_my_students';
      }

      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          alert(data.message);
          bootstrap.Modal.getInstance(modal).hide();
          window.location.reload();
        } else {
          alert('Erro ao enviar mensagem: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Erro ao enviar mensagem');
      });
    });
  }
});
</script>
